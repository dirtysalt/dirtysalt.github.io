<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.5.14 (465167)"/><meta name="created" content="2018-10-11 00:15:50 +0000"/><meta name="source" content="web.clip7"/><meta name="source-application" content="WebClipper 7"/><meta name="source-url" content="https://time.geekbang.org/column/article/730"/><meta name="updated" content="2018-10-11 00:16:03 +0000"/><title>极客时间 | 左耳听风 - 13 | 魔数 0x5f3759df</title></head><body>
  <div>
<div style="font-size: 16px; display:block; min-width: 100%; "> <div style="background-color:transparent;font:inherit;vertical-align:baseline;"><div style="background-color:transparent;font:inherit;vertical-align:baseline;font-family:&quot;PT Serif&quot;;font-size:16px;line-height:1.5em;color:rgb(31, 9, 9);text-align:left;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><div style="position:relative;vertical-align:baseline;font:inherit;border:0px;padding:0px;margin:0px;z-index:200;margin-right:auto;margin-left:auto;padding-right:2em;padding-left:2em;width:36em;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;position:relative;margin-left:-25px;margin-right:25px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;padding-top:4.5em;padding-bottom:9em;position:relative;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;position:relative;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><h1 style="font:inherit;font-family:&quot;PT Serif&quot;;vertical-align:baseline;text-align:left;border:0px;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;margin:0px;padding:0px;">极客时间 | 左耳听风</h1><div style="padding:0px;padding-bottom:1.5em;margin:0px;height:1em;line-height:1;text-align:center;position:relative;border:0px;font:inherit;vertical-align:baseline;padding-top:1.5em;margin-bottom:0px;"><div style="padding-right:4em;vertical-align:baseline;font:inherit;border:0px;padding:0px;margin:0px;z-index:10;padding-left:4em;position:absolute;height:0.1em;width:100%;opacity:0.5;top:50%;left:-4em;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);margin-bottom:0px;"><span style="font:inherit;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);position:absolute;left:-4em;top:50%;z-index:10;width:100%;padding-left:4em;padding-right:4em;height:0.1em;margin:0px;opacity:0.5;"/></div></div></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-6a1e5c799cdd46a5bed8331ba9917828.jpg" height="640" width="1142"/></div>   <p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">下列代码是在《雷神之锤 III 竞技场》源代码中的一个函数（已经剥离了 C 语言预处理器的指令）。其实，最早在 2002 年（或 2003 年）时，这段平方根倒数速算法的代码就已经出现在 Usenet 与其他论坛上了。这段代码在程序员圈内引起了非常大的讨论。</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">float Q_rsqrt( float number )</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">{</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    long i;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    float x2, y;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    const float threehalfs = 1.5F;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    x2 = number * 0.5F;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    y  = number;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    i  = * ( long * ) &amp;y; // evil floating point bit level hacking</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    i  = 0x5f3759df - ( i &gt;&gt; 1 );  // what the fuck? </div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    y  = * ( float * ) &amp;i;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    y  = y * ( threehalfs - ( x2 * y * y ) );  // 1st iteration </div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    // 2nd iteration, this can be removed</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    // y  = y * ( threehalfs - ( x2 * y * y ) ); </div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    return y;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">}</div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这段代码读起来完全不知所云，尤其是那个魔数 0x5f3759df，完全不知道是个什么东西，所以，注释里也是 What the fuck。今天的这篇文章主要是想带你来了解一下这个函数中的代码究竟是怎样出来的。</p>

<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">其实，这个函数的作用是求平方根倒数，即 <span>x−1/2</span><span><span><span>x</span><span><span>−</span><span>1</span><span><span>/</span></span><span>2</span></span></span></span>，也就是下面这个算式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>1x√</span><span><span><span>1</span><span><span>x</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">当然，它算的是近似值。只不过这个近似值的精度很高，而且计算成本比传统的浮点数运算平方根的算法低太多。在以前那个计算资源还不充分的年代，在一些 3D 游戏场景的计算机图形学中，要求取照明和投影的光照与反射效果，就经常需要计算平方根倒数，而且是大量的计算——对一个曲面上很多的点做平方根倒数的计算。也就是需要用到下面的这个算式，其中的 x,y,z 是 3D 坐标上的一个点的三个坐标值。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>1x2+y2+z2‾‾‾‾‾‾‾‾‾‾‾‾√</span><span><span><span>1</span><span><span><span>x</span><span><span>2</span></span></span><span>+</span><span><span>y</span><span><span>2</span></span></span><span>+</span><span><span>z</span><span><span>2</span></span></span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">基本上来说，在一个 3D 游戏中，我们每秒钟都需要做上百万次平方根倒数运算。而在计算硬件还不成熟的时代，这些计算都需要软件来完成，计算速度非常慢。我们要知道，在上世纪 90 年代，多数浮点数操作的速度更是远远滞后于整数操作。所以，这段代码所带来的作用是非常大的。</p>
<h1 style="font:inherit;font-family:&quot;PT Serif&quot;;margin:0px;padding:0px;border:0px;text-align:left;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;">计算机的浮点数表示</h1>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">为了讲清楚这段代码，我们需要先了解一下计算机的浮点数表示法。在 C 语言中，计算机的浮点数表示用的是 IEEE 754 标准，这个标准的表现形式为，把一个 32bits 分成三段。</p>
<ul style="padding:0px;border:0px;font:inherit;vertical-align:baseline;margin:0px 0px 1.5em 1.5em;list-style:disc outside none;margin-top:-1em;list-style-type:disc;">
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">第一段占 1bit。表示符号位。代称为 S（sign）。</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">第二段占 8bits。表示指数。代称为 E（Exponent）。</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">第三段占 23bits。表示尾数。代称为 M（Mantissa）。</li>
</ul>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">如下图所示：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-cfb465ac3800ceb3f8a8997fe527c8a2.jpg" height="204" width="863"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">然后呢，一个小数的计算方式是下面这个算式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(−1)S∗(1+M223)∗2(E−127)</span><span><span>(</span><span>−</span><span>1</span><span><span>)</span><span><span>S</span></span></span><span>∗</span><span>(</span><span>1</span><span>+</span><span><span>M</span><span><span>2</span><span><span>23</span></span></span></span><span>)</span><span>∗</span><span><span>2</span><span><span>(</span><span>E</span><span>−</span><span>127</span><span>)</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">但是，这个算式基本上来说，完全就是让人一头雾水，摸不着门路。对于浮点数的解释基本上就是下面这张漫画里表现的样子。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-7d607f3f90fe6e8152e2268da18e1feb.png" height="780" width="446"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">下面，让我来试着解释一下浮点数的那三段表示什么意思。</p>
<ul style="padding:0px;border:0px;font:inherit;vertical-align:baseline;margin:0px 0px 1.5em 1.5em;list-style:disc outside none;margin-top:-1em;list-style-type:disc;">
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">第一段符号位。对于这一段，我相信应该没有人不能理解。</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">第二段指数位。什么叫指数？也就是说，对于任何数 x，其都可以找到一个 <span>n</span><span><span>n</span></span>，使得 <span>2n</span><span><span><span>2</span><span><span>n</span></span></span></span>&lt;=x&lt;=<span>2n+1</span><span><span><span>2</span><span><span>n</span><span>+</span><span>1</span></span></span></span>。比如：对于 3 来说，因为 2 &lt; 3 &lt; 4，所以 n=1。而浮点数的这个指数为了要表示 0.00x 的小数，所以需要有负数，这 8 个 bits 本来可以表示 0-255。为了表示负的，取值要放在 [-127,128] 这个区间中。这就是为什么我们在上面的公式中看到的 <span>2(E−127)</span><span><span><span>2</span><span><span>(</span><span>E</span><span>−</span><span>127</span><span>)</span></span></span></span> 这一项了。也就是说，<span>n=E−127</span><span><span>n</span><span>=</span><span>E</span><span>−</span><span>127</span></span>，如果 <span>n=1</span><span><span>n</span><span>=</span><span>1</span></span>，那么 <span>E</span><span><span>E</span></span> 就是 128 了。</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">第三段尾数位。也就是小数位，但是这里叫偏移量可能好一些。这里的取值是从 [ 0 - <span>223</span><span><span><span>2</span><span><span>23</span></span></span></span>] 中。你可以认为，我们把一条线分成 <span>223</span><span><span><span>2</span><span><span>23</span></span></span></span> 个线段，也就是 8388608 个线段。也就是说，把 <span>2n</span><span><span><span>2</span><span><span>n</span></span></span></span> 到 <span>2n+1</span><span><span><span>2</span><span><span>n</span><span>+</span><span>1</span></span></span></span> 分成了 8388608 个线段。而存储的 M 值，就是从 <span>2n</span><span><span><span>2</span><span>n</span></span></span> 到 x 要经过多少个段。这要计算一下，<span>2n</span><span><span><span>2</span><span><span>n</span></span></span></span> 到 x 的长度占 <span>2n</span><span><span><span>2</span><span><span>n</span></span></span></span> 到 <span>2n+1</span><span><span><span>2</span><span><span>n</span><span>+</span><span>1</span></span></span></span> 长度的比例是多少。</p>
</li>
</ul>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我估计你对第三段还是有点不懂，那么我们来举一个例子。比如说，对 3.14 这个小数。</p>
<ul style="padding:0px;border:0px;font:inherit;vertical-align:baseline;margin:0px 0px 1.5em 1.5em;list-style:disc outside none;margin-top:-1em;list-style-type:disc;">
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">是正数。所以，S = 0</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><span>21</span><span><span><span>2</span><span>1</span></span></span> &lt; 3.14 &lt;<span>22</span><span><span><span>2</span><span>2</span></span></span>。所以，n=1， n+127 = 128。所以，E=128。</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(3.14 - 2) / (4 - 2) = 0.57， 而 <span>0.57∗223=4781506.56</span><span><span>0.57</span><span>∗</span><span><span>2</span><span><span>23</span></span></span><span>=</span><span>4781506.56</span></span>，四舍五入，得到 M = 4781507。因为有四舍五入，所以，产生了浮点数据的精度问题。</p>
</li>
</ul>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">把 S、E、M 转成二进制，得到 3.14 的二进制表示。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><img src="images/%E6%9E%81%E5%AE%A2-3f99e711a80ebe963bd5ca4139224915.jpg" height="80" width="868"/></p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们再用 IEEE 754 的那个算式来算一下：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(−1)0∗(1+4781507223)∗2(128−127)</span><span><span><span><span>(</span><span>−</span><span>1</span><span>)</span></span><span>0</span></span><span>∗</span><span>(</span><span><span>1</span><span>+</span><span><span>4781507</span><span><span>2</span><span><span>23</span></span></span></span></span><span>)</span><span>∗</span><span><span>2</span><span><span>(</span><span>128</span><span>−</span><span>127</span><span>)</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>1∗(1+0.5700000524520874)∗2</span><span><span>1</span><span>∗</span><span>(</span><span>1</span><span>+</span><span>0.5700000524520874</span><span>)</span><span>∗</span><span>2</span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=3.1400001049041748046875</span><span><span>=</span><span>3.1400001049041748046875</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">你看，浮点数的精度问题出现了。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们再来看一个示例，小数 0.015。</p>
<ul style="padding:0px;border:0px;font:inherit;vertical-align:baseline;margin:0px 0px 1.5em 1.5em;list-style:disc outside none;margin-top:-1em;list-style-type:disc;">
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">是正数。所以，S = 0。</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><span>2−7&lt;0.015&lt;2−6</span><span><span><span>2</span><span><span>−</span><span>7</span></span></span><span>&lt;</span><span>0.015</span><span>&lt;</span><span><span>2</span><span><span>−</span><span>6</span></span></span></span> 。所以，n=-7， n+127 = 120。所以，E=120。</p>
</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"><span>(0.015−2−7)/(2−6−2−7)</span><span><span>(</span><span>0.015</span><span>−</span><span><span>2</span><span><span>−</span><span>7</span></span></span><span>)</span><span><span>/</span></span><span>(</span><span><span>2</span><span><span>−</span><span>6</span></span></span><span>−</span><span><span>2</span><span><span>−</span><span>7</span></span></span><span>)</span></span> = <span>0.0071875/0.0078125=0.92</span><span><span>0.0071875</span><span><span>/</span></span><span>0.0078125</span><span>=</span><span>0.92</span></span>。而 <span>0.92∗223=7717519.36</span><span><span>0.92</span><span>∗</span><span><span>2</span><span><span>23</span></span></span><span>=</span><span>7717519.36</span></span>，四舍五入，得到 M = 7717519。</p>
</li>
</ul>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">于是，我们得到 0.015 的二进制编码：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-bd3c8cae032d818084f2d1ac0a02acde.jpg" height="97" width="807"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">其中：</p>
<ul style="padding:0px;border:0px;font:inherit;vertical-align:baseline;margin:0px 0px 1.5em 1.5em;list-style:disc outside none;margin-top:-1em;list-style-type:disc;">
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">120 的二进制是 01111000</li>
<li style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;">7717519 的二进制是 11101011100001010001111</li>
</ul>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">返回过来算一下：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(−1)0∗(1+7717519223)∗2(120−127)</span><span><span>(</span><span>−</span><span>1</span><span><span>)</span><span><span>0</span></span></span><span>∗</span><span>(</span><span>1</span><span>+</span><span><span>7717519</span><span><span>2</span><span><span>23</span></span></span></span><span>)</span><span>∗</span><span><span>2</span><span><span>(</span><span>120</span><span>−</span><span>127</span><span>)</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(1+0.919999957084656)∗0.0078125</span><span><span>(</span><span>1</span><span>+</span><span>0.919999957084656</span><span>)</span><span>∗</span><span>0.0078125</span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=0.014999999664724</span><span><span>=</span><span>0.014999999664724</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">你看，浮点数的精度问题又出现了。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们来用 C 语言验证一下：</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">int main() {</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    float x = 3.14;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    float y = 0.015;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    return 0;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">}</div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">在我的 Mac 上用 lldb 工具 Debug 一下。</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(lldb) frame variable</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(float) x = 3.1400001</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(float) y = 0.0149999997</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(lldb) frame variable -f b</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(float) x = 0b01000000010010001111010111000011</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">(float) y = 0b00111100011101011100001010001111</div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">从结果上，完全验证了我们的方法。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">好了，不知道你看懂了没有？我相信你应该看懂了。</p>
<h1 style="font:inherit;font-family:&quot;PT Serif&quot;;margin:0px;padding:0px;border:0px;text-align:left;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;">简化浮点数公式</h1>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">因为那个浮点数表示的公式有点复杂，我们简化一下：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(−1)S∗(1+M223)∗2(E−127)</span><span><span>(</span><span>−</span><span>1</span><span><span>)</span><span><span>S</span></span></span><span>∗</span><span>(</span><span>1</span><span>+</span><span><span>M</span><span><span>2</span><span><span>23</span></span></span></span><span>)</span><span>∗</span><span><span>2</span><span><span>(</span><span>E</span><span>−</span><span>127</span><span>)</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们令，<span>m=(M223)</span><span><span>m</span><span>=</span><span>(</span><span><span>M</span><span><span>2</span><span><span>23</span></span></span></span><span>)</span></span>，<span>e=(E−127)</span><span><span>e</span><span>=</span><span>(</span><span>E</span><span>−</span><span>127</span><span>)</span></span>。因为符号位在 <span>y=x−12</span><span><span>y</span><span>=</span><span><span>x</span><span><span>−</span><span><span>1</span><span>2</span></span></span></span></span> 的两端都是 0（正数），也就可以去掉，所以浮点数的算式简化为：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>(1+m)∗2e</span><span><span>(</span><span>1</span><span>+</span><span>m</span><span>)</span><span>∗</span><span><span>2</span><span><span>e</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">上面这个算式是从一个 32bits 二进制计算出一个浮点数。这个 32bits 的整型算式是：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>M+E∗223</span><span><span>M</span><span>+</span><span>E</span><span>∗</span><span><span>2</span><span><span>23</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">比如，0.015 的 32bits 的二进制是：00111100011101011100001010001111，也就是整型的：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>7717519+120∗223</span><span><span>7717519</span><span>+</span><span>120</span><span>∗</span><span><span>2</span><span><span>23</span></span></span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=1014350479</span><span><span>=</span><span>1014350479</span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=0X3C75C28F</span><span><span>=</span><span>0</span><span>X</span><span>3</span><span>C</span><span>75</span><span>C</span><span>28</span><span>F</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<h1 style="font:inherit;font-family:&quot;PT Serif&quot;;margin:0px;padding:0px;border:0px;text-align:left;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;">平方根倒数公式推导</h1>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">下面，你会看到好多数学公式，但是请你不要怕，因为这些数学公式只需要高中数学就能看懂的。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们来看一下，平方根数据公式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>y=1x√2=x−12</span><span><span>y</span><span>=</span><span><span>1</span><span><span>x</span><span>2</span></span></span><span>=</span><span><span>x</span><span><span>−</span><span><span>1</span><span>2</span></span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">等式两边取以 2 为基数的对数，就有了：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>log2(y)=−12log2(x)</span><span><span><span>log</span><span>2</span></span><span>⁡</span><span>(</span><span>y</span><span>)</span><span>=</span><span>−</span><span><span>1</span><span>2</span></span><span><span>log</span><span>2</span></span><span>⁡</span><span>(</span><span>x</span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">因为我们实际上在算浮点数，所以将公式中的 x 和 y 分别用浮点数的那个浮点数的简化算式 <span>(1+m)∗2e</span><span><span>(</span><span>1</span><span>+</span><span>m</span><span>)</span><span>∗</span><span><span>2</span><span>e</span></span></span> 替换掉。代入 <span>log()</span><span><span>log</span><span>⁡</span><span>(</span><span>)</span></span> 公式中，我们也就有了下面的公式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>log2(1+my)+ey</span><span><span><span>log</span><span><span>2</span></span></span><span>⁡</span><span>(</span><span>1</span><span>+</span><span><span>m</span><span>y</span></span><span>)</span><span>+</span><span><span>e</span><span>y</span></span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=−12(log2(1+mx)+ex)</span><span><span>=</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span>log</span><span>2</span></span><span>⁡</span><span>(</span><span>1</span><span>+</span><span><span>m</span><span>x</span></span><span>)</span><span>+</span><span><span>e</span><span>x</span></span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">因为有对数，这公式看着就很麻烦，似乎不能再简化了。但是，我们知道，所谓的 <span>mx</span><span><span><span>m</span><span>x</span></span></span> 或是 <span>my</span><span><span><span>m</span><span>y</span></span></span>，其实是个在 0 和 1 区间内的小数。在这种情况下，<span>log2(1.x)</span><span><span><span>log</span><span>2</span></span><span>⁡</span><span>(</span><span>1.</span><span>x</span><span>)</span></span> 接近一条直线。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-2d2b69795d3aa4d07545f0bbe645574e.png" height="649" width="865"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">那么我们就可以使用一个直线方程来代替，也就是：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>log2(1+m)≈m+σ</span><span><span><span>log</span><span><span>2</span></span></span><span>⁡</span><span>(</span><span>1</span><span>+</span><span>m</span><span>)</span><span>≈</span><span>m</span><span>+</span><span>σ</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">于是，我们的公式就简化成了：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>my+σ+ey≈−12(mx+σ+ex)</span><span><span><span>m</span><span>y</span></span><span>+</span><span>σ</span><span>+</span><span><span>e</span><span>y</span></span><span>≈</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span>m</span><span>x</span></span><span>+</span><span>σ</span><span>+</span><span><span>e</span><span>x</span></span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">因为 <span>m=(M223)</span><span><span>m</span><span>=</span><span>(</span><span><span>M</span><span><span>2</span><span><span>23</span></span></span></span><span>)</span></span>，<span>e=(E−127)</span><span><span>e</span><span>=</span><span>(</span><span>E</span><span>−</span><span>127</span><span>)</span></span>，代入公式，得到：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>My223+σ+Ey−127</span><span><span><span><span>M</span><span>y</span></span><span><span>2</span><span><span>23</span></span></span></span><span>+</span><span>σ</span><span>+</span><span><span>E</span><span>y</span></span><span>−</span><span>127</span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>≈−12(Mx223+σ+Ex−127)</span><span><span>≈</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span><span>M</span><span>x</span></span><span><span>2</span><span><span>23</span></span></span></span><span>+</span><span>σ</span><span>+</span><span><span>E</span><span>x</span></span><span>−</span><span>127</span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">移项整理一下，把 σ 和 127 从左边，移到右边：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>My223+Ey≈−12(Mx223+Ex)−32(σ−127)</span><span><span><span><span>M</span><span>y</span></span><span><span>2</span><span><span>23</span></span></span></span><span>+</span><span><span>E</span><span>y</span></span><span>≈</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span><span>M</span><span>x</span></span><span><span>2</span><span><span>23</span></span></span></span><span>+</span><span><span>E</span><span>x</span></span><span>)</span><span>−</span><span><span>3</span><span>2</span></span><span>(</span><span>σ</span><span>−</span><span>127</span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">再把整个表达式乘以 <span>223</span><span><span><span>2</span><span><span>23</span></span></span></span>，得到：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>My+Ey223</span><span><span><span><span>M</span><span>y</span></span></span><span>+</span><span><span>E</span><span>y</span></span><span><span><span>2</span><span><span>23</span></span></span></span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>≈−12(Mx+Ex223)−32(σ−127)223</span><span><span>≈</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span>M</span><span>x</span></span><span>+</span><span><span>E</span><span>x</span></span><span><span><span>2</span><span><span>23</span></span></span></span><span>)</span><span>−</span><span><span>3</span><span>2</span></span><span>(</span><span>σ</span><span>−</span><span>127</span><span>)</span><span><span><span>2</span><span><span>23</span></span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">可以看到一个常数：<span>−32(σ−127)223</span><span><span>−</span><span><span>3</span><span>2</span></span><span>(</span><span>σ</span><span>−</span><span>127</span><span>)</span><span><span><span>2</span><span><span>23</span></span></span></span></span>，把负号放进括号里，变成 <span>32(127−σ)223</span><span><span><span>3</span><span>2</span></span><span>(</span><span>127</span><span>−</span><span>σ</span><span>)</span><span><span><span>2</span><span><span>23</span></span></span></span></span>，并可以用一个常量代数 R 来取代，于是得到公式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>My+Ey223≈R−12(Mx+Ex223)</span><span><span><span><span>M</span><span>y</span></span></span><span>+</span><span><span>E</span><span>y</span></span><span><span><span>2</span><span><span>23</span></span></span></span><span>≈</span><span>R</span><span>−</span><span><span>1</span><span>2</span></span><span>(</span><span><span>M</span><span>x</span></span><span>+</span><span><span>E</span><span>x</span></span><span><span><span>2</span><span><span>23</span></span></span></span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">还记得我们前面那个“浮点数 32bits 二进制整型算式” <span>M+E∗223</span><span><span>M</span><span>+</span><span>E</span><span>∗</span><span><span>2</span><span><span>23</span></span></span></span> 吗？假设，浮点数 x 的 32bits 的整型公式是：<span>Ix=Mx+Ex223</span><span><span><span>I</span><span>x</span></span><span>=</span><span><span>M</span><span>x</span></span><span>+</span><span><span>E</span><span>x</span></span><span><span>2</span><span><span>23</span></span></span></span>，那么上面的公式就可以写成：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>Iy≈R−12Ix</span><span><span><span>I</span><span>y</span></span><span>≈</span><span>R</span><span>−</span><span><span>1</span><span>2</span></span><span><span>I</span><span>x</span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<h1 style="font:inherit;font-family:&quot;PT Serif&quot;;margin:0px;padding:0px;border:0px;text-align:left;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;">代码分析</h1>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">让我们回到文章的主题，那个平方根函数的代码。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">首先是：</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">i  = * ( long * ) &amp;y; // evil floating point bit level hacking</div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这行代码就是把一个浮点数的 32bits 的二进制转成整型。也就是，前面我们例子里说过的，3.14 的 32bits 的二进制是：01000000010010001111010111000011，整型是：1078523331。即 y = 3.14，i = 1078523331。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">然后是：</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">i  = 0x5f3759df - ( i &gt;&gt; 1 );  // what the fuck? </div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这就是：</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">i  = 0x5f3759df - ( i / 2 );  </div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">也就是我们上面推导出来的那个公式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>Iy≈R−12Ix</span><span><span><span>I</span><span>y</span></span><span>≈</span><span>R</span><span>−</span><span><span>1</span><span>2</span></span><span><span>I</span><span>x</span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">代码里的 R = 0x5f3759df。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">我们又知道，R = <span>32(127−σ)223</span><span><span><span>3</span><span>2</span></span><span>(</span><span>127</span><span>−</span><span>σ</span><span>)</span><span><span><span>2</span><span><span>23</span></span></span></span></span>，把代码中的那个魔数代入，就可以计算出来：σ= 0.0450465 。这个数是个神奇的数字，这个数是怎么算出来的，现在还没人知道。不过，我们先往下看后面的代码：</p>
<pre style="background-color:rgb(243, 242, 238);font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;width:auto;font-size:0.875em;line-height:1.71429em;"><code style="font-family:Inconsolata;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;line-height:1.71429em;font-size:1.15em;"><table style="padding:0px;border-spacing:0px;font-style:inherit;font-variant:inherit;border-collapse:collapse;margin:0px;font-weight:inherit;border:0px;font:inherit;vertical-align:baseline;font-size:1em;margin-bottom:0px;"><tbody style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    x2 = number * 0.5F;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    y  = * ( float * ) &amp;i;</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    y  = y * ( threehalfs - ( x2 * y * y ) );  // 1st iteration </div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    // 2nd iteration, this can be removed</div></td></tr><tr style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">    // y  = y * ( threehalfs - ( x2 * y * y ) ); </div></td></tr></tbody></table></code><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;">复制代码</div></pre>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这段代码相当于下面这个公式：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>Iy′=Iy(1.5−0.5xI2y)</span><span><span><span>I</span><span><span><span>y</span><span>′</span></span></span></span><span>=</span><span><span>I</span><span>y</span></span><span>(</span><span>1.5</span><span>−</span><span>0.5</span><span>x</span><span><span>I</span><span>y</span><span>2</span></span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这个其实是“牛顿求根法”，这是一个为了找到一个 f(x)= 0 的根而用一种不断逼近的计算方式。请看下图：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-d9c070d857b29966ecb9eeab49057ce0.jpg" height="438" width="327"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">首先，初始值为 X0，然后找到 X0 所对应的 Y0（把 X0 代入公式得到 Y0 = f(X0)），然后在（X0,Y0）这个点上做一个切线，得到与 X 轴交汇的 X1。再用 X1 做一次上述的迭代，得到 X2，就这样一直迭代下去，一直找到，y = 0 时，x 的值。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">牛顿法的通用公式是：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>xn+1=xn−f(xn)f′(xn)</span><span><span><span>x</span><span><span>n</span><span>+</span><span>1</span></span></span><span>=</span><span><span>x</span><span>n</span></span><span>−</span><span><span><span>f</span><span>(</span><span><span>x</span><span>n</span></span><span>)</span></span><span><span><span>f</span><span>′</span></span><span>(</span><span><span>x</span><span>n</span></span><span>)</span></span></span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">于是，对于 <span>y=1x√</span><span><span>y</span><span>=</span><span><span>1</span><span><span>x</span></span></span></span> 来说，对固定的 x（常数），我们求 y 使得 <span>1y2−x=0</span><span><span><span>1</span><span><span>y</span><span>2</span></span></span><span>−</span><span>x</span><span>=</span><span>0</span></span>，<span>f(y)=1y2−x</span><span><span>f</span><span>(</span><span>y</span><span>)</span><span>=</span><span><span>1</span><span><span>y</span><span>2</span></span></span><span>−</span><span>x</span></span> ,  <span>f′(y)=−2y3</span><span><span><span>f</span><span>′</span></span><span>(</span><span>y</span><span>)</span><span>=</span><span><span><span>−</span><span>2</span></span><span><span>y</span><span>3</span></span></span></span> 。 注意：<span>f′(y)</span><span><span><span>f</span><span>′</span></span><span>(</span><span>y</span><span>)</span></span> 是 <span>f(y)</span><span><span>f</span><span>(</span><span>y</span><span>)</span></span> 关于 y 的导数。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">代入上述的牛顿法的通用公式后得到：</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>yn+1=yn−1y2n−x−2y3n</span><span><span><span>y</span><span><span>n</span><span>+</span><span>1</span></span></span><span>=</span><span><span>y</span><span>n</span></span><span>−</span><span><span><span><span>1</span><span><span>y</span><span>n</span><span>2</span></span></span><span>−</span><span>x</span></span><span><span><span>−</span><span>2</span></span><span><span>y</span><span>n</span><span>3</span></span></span></span></span></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"><span>=yn(3−xy2n)2=yn(1.5−0.5xy2n)</span><span><span>=</span><span><span><span><span>y</span><span>n</span></span><span>(</span><span>3</span><span>−</span><span>x</span><span><span>y</span><span>n</span><span>2</span></span><span>)</span></span><span>2</span></span><span>=</span><span><span>y</span><span>n</span></span><span>(</span><span>1.5</span><span>−</span><span>0.5</span><span>x</span><span><span>y</span><span>n</span><span>2</span></span><span>)</span></span></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">正好就是我们上面的代码。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">整个代码是，之前生成的整数操作产生首次近似值后，将首次近似值作为参数送入函数最后两句进行精化处理。代码中的两次迭代正是为了进一步提高结果的精度。但由于《雷神之锤 III》的图形计算中并不需要太高的精度，所以代码中只进行了一次迭代，二次迭代的代码则被注释了。</p>
<h1 style="font:inherit;font-family:&quot;PT Serif&quot;;margin:0px;padding:0px;border:0px;text-align:left;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;">相关历史</h1>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">根据 Wikipedia 上的描述。《雷神之锤 III》的代码直到 QuakeCon 2005 才正式放出，但早在 2002 年（或 2003 年）时，平方根倒数速算法的代码就已经出现在 Usenet 和其他论坛上了。最初人们猜测是《雷神之锤》的创始人 John Carmack 写下了这段代码，但他在回复询问他的邮件时否定了这个观点，并猜测可能是先前曾帮 id Software 优化《雷神之锤》的资深汇编程序员 Terje Mathisen 写下了这段代码。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">而 Mathisen 的邮件里表示，在 1990 年代初，他只曾做过类似的实现，确切来说这段代码亦非他所作。现在所知的最早实现是由 Gary Tarolli 在 SGI Indigo 中实现的，但他亦坦承他仅对常数 R 的取值做了一定的改进，实际上他也不是作者。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">在向以发明 MATLAB 而闻名的 Cleve Moler 查证后，Rys Sommefeldt 则认为原始的算法是 Ardent Computer 公司的 Greg Walsh 所发明的，但他也没有任何确定性的证据能证明这一点。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">不仅该算法的原作者不明，人们也仍无法确定当初选择这个“魔术数字”的方法。Chris Lomont 曾做了个研究：他推算出了一个函数以讨论此速算法的误差，并找出了使误差最小的最佳 R 值 0x5f37642f（与代码中使用的 0x5f3759df 相当接近）。但以之代入算法计算并进行一次牛顿迭代后，所得近似值之精度仍略低于代入 0x5f3759df 的结果。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">因此，Lomont 将目标改为查找在进行 1-2 次牛顿迭代后能得到最大精度的 R 值，在暴力搜索后得出最优 R 值为 0x5f375a86，以此值代入算法并进行牛顿迭代，所得的结果都比代入原始值（0x5f3759df）更精确。于是他说，“如果可能我想询问原作者，此速算法是以数学推导还是以反复试错的方式求出来的？”</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">Lomont 亦指出，64 位的 IEEE754 浮点数（即双精度类型）所对应的魔术数字是 0x5fe6ec85e7de30da。但后来的研究表明，代入 0x5fe6eb50c7aa19f9 的结果精确度更高（McEniry 得出的结果则是 0x5fe6eb50c7b537aa，精度介于两者之间）。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">后来 Charles McEniry 使用了一种类似 Lomont 但更复杂的方法来优化 R 值。他最开始使用穷举搜索，所得结果与 Lomont 相同。而后他尝试用带权二分法寻找最优值，所得结果恰是代码中所使用的魔术数字 0x5f3759df。因此，McEniry 认为，这一常数最初或许便是以“在可容忍误差范围内使用二分法”的方式求得。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;">这可能是编程世界里最经典的魔数的故事，希望你能够从这篇文章中收获一些数学的基础知识。数学真是需要努力学习好的一门功课，尤其在人工智能火热的今天。</p>
<p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;"/><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;text-align:center;margin-bottom:1em;margin-top:1em;"><img src="images/%E6%9E%81%E5%AE%A2-fcc761001867c60f526665e237f831e9.jpg" height="535" width="1082"/></div><p style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:0px;"/>
</div></div></div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;position:absolute;top:-1000px;left:-1000px;">Measure</div><div style="margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;position:absolute;top:-1000px;left:-1000px;line-height:1;margin-bottom:0px;">Measure</div></div></div></div><div style="height:100%;display:none;vertical-align:baseline;font:inherit;border:0px;padding:0px;margin:0px;z-index:100;width:100%;right:0px;top:0px;position:fixed;background-color:rgb(243, 242, 238);"/></div></div></div></div>
</div>
</body></html>