<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.5.14 (465167)"/><meta name="created" content="2018-10-10 23:42:51 +0000"/><meta name="source" content="web.clip7"/><meta name="source-application" content="WebClipper 7"/><meta name="source-url" content="https://time.geekbang.org/column/article/675"/><meta name="updated" content="2018-10-10 23:44:47 +0000"/><title>极客时间 | 左耳听风 - 11 | 程序中的错误处理：错误返回码和异常捕捉</title></head><body><div style="font-size: 16px; min-width: 100%;"><div style="font-size: inherit; vertical-align: baseline;"><div style="vertical-align: baseline; font-size: 16px; text-align: left;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><div style="position: relative; vertical-align: baseline; font-size: inherit; border: 0px; padding: 0px 2em; margin: 0px auto; z-index: 200; width: 36em;"><div style="margin: 0px 25px 0px -25px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; position: relative;"><div style="margin: 0px; padding: 4.5em 0px 9em; border: 0px; font-size: inherit; vertical-align: baseline; position: relative;"><div style="margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; position: relative;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><div style="background-color: transparent; margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><h1 style="vertical-align: baseline; text-align: left; border: 0px; font-size: 35px; margin: 0px; padding: 0px;"><span style="font-size: 35px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 35px; font-weight: normal;">传统的错误检查</span></h1><div style="padding: 1.5em 0px; margin: 0px; height: 1em; text-align: center; position: relative; border: 0px; font-size: inherit; vertical-align: baseline;"><div style="padding-right:4em;vertical-align:baseline;font:inherit;border:0px;padding:0px;margin:0px;z-index:10;padding-left:4em;position:absolute;height:0.1em;width:100%;opacity:0.5;top:50%;left:-4em;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);margin-bottom:0px;"/></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">首先，我们知道，处理错误最直接的方式是通过错误码，这也是传统的方式，在过程式语言中通常都是用这样的方式处理错误的。比如 C 语言，基本上来说，其通过函数的返回值标识是否有错，然后通过全局的</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">变量并配合一个 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errstr</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 的数组来告诉你为什么出错。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">为什么是这样的设计？道理很简单，除了可以共用一些错误，更重要的是这其实是一种妥协。比如：</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">read()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">, </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">write()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">, </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">open()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这些函数的返回值其实是返回有业务逻辑的值。也就是说，这些函数的返回值有两种语义，一种是成功的值，比如 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">open()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 返回的文件句柄指针 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">FILE*</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> ，或是错误 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">NULL</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。这样会导致，调用者并不知道是什么原因出错了，需要去检查 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 来获得出错的原因，从而可以正确地处理错误。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">一般而言，这样的错误处理方式在大多数情况下是没什么问题的。但是也有例外的情况，我们来看一下下面这个 C 语言的函数：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">int atoi(const char *str)</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">这个函数是把一个字符串转成整型。但是问题来了，如果一个要传的字符串是非法的（不是数字的格式），如 "ABC" 或者整型溢出了，那么这个函数应该返回什么呢？出错返回，返回什么数都不合理，因为这会和正常的结果混淆在一起。比如，返回 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">0</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">，那么会和正常的对 “0” 字符的返回值完全混淆在一起。这样就无法判断什么是出错的情况，什么时候是正确的情况。你可能会说，是不是要检查一下 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">，按道理说应该是要去检查的，但是，我们在 C99 的规格说明书中可以看到这样的描述——</span></div><blockquote style="background-color: transparent; quotes: none; margin: 0px 0px 1.5em 2em; border-width: 0px 0px 0px 5px; font-size: inherit; vertical-align: baseline; padding: 0px 0px 0px 1em; border-left-style: solid;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-style: italic;"
/><div style="margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-style: italic;">7.20.1</span></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-style: italic;">The functions atof, atoi, atol, and atoll need not affect the value of the integer expression errno on an error. If the value of the result cannot be represented, the behavior is undeﬁned.</span></div></blockquote><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">像</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">atoi()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">, </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">atof()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">, </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">atol()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 或是 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">atoll()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的函数是不会设置 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">的，而且，还说了，如果结果无法计算的话，行为是</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">undefined</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。所以，后来，libc 又给出了一个新的函数</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">strtol()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">，这个函数在出错的时会设置全局变量</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> ：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">long strtol(const char *restrict str, char **restrict endptr, int base);</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">于是，我们就可以这样使用：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">long val = strtol(in_str, &amp;endptr, 10);  //10 的意思是 10 进制</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">// 如果无法转换</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">if (endptr == str) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    fprintf(stderr, "No digits were found\n");</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    exit(EXIT_FAILURE);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">// 如果整型溢出了</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">if ((errno == ERANGE &amp;&amp; (val == LONG_MAX || val == LONG_MIN)) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    fprintf(stderr, "ERROR: number out of range for LONG\n");</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    exit(EXIT_FAILURE);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;"> }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">// 如果是其它错误</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">if (errno != 0 &amp;&amp; val == 0) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    perror("strtol");</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    exit(EXIT_FAILURE);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">虽然，</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">strtol()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 函数解决了 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">atoi()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 函数的问题，但是我们还是能感觉到不是很舒服和自然。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">因为，这种用 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">返回值</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> + </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">errno</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 的错误检查方式会有一些问题:</span></div><ul style="background-color: transparent; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">程序员一不小心就会忘记返回值的检查，而造成代码的 Bug；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">函数接口非常不纯洁，正常值和错误值混淆在一起，导致语义有问题。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">所以，后来，有一些类库就开始区分这样的事情。比如，Windows 的系统调用开始使用 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">HRESULT</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 的返回来统一错误的返回值，这样可以明确函数调用时的返回值就是成功还是错误。但这样一来，函数的 input 和 output 只能通过函数的参数来完成，于是出现了所谓的 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">入参</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 和 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">出参</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的区别。然而，这又使得函数接入中参数的语义变得复杂，一些参数是入参，一些参数是出参，函数接口变得复杂了一些。而且，依然没有解决函数的成功或失败可以被人为忽略的问题。</span></div><h1 style="background-color: transparent; margin: 0px 0px 20px; padding: 0px; border: 0px; text-align: left; vertical-align: baseline; font-size: 35px;"><span style="font-size: 35px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 35px; font-weight: normal;">多返回值</span></h1><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">于是，有一些语言通过多返回值来解决这个问题，比如 Go 语言。Go 语言的很多函数都会返回 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">result, err</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 两个值，于是:</span></div><ul style="background-color: transparent; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">参数上基本上就是入参，而返回接口把结果和错误分离，这样使得函数的接口语义清晰；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">而且，Go 语言中的错误参数如果要忽略，需要显式地忽略，用 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">_</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的变量来忽略；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">另外，因为返回的 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">error</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 是个接口（其中只有一个方法 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">Error()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">，返回一个 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">string</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> ），于是你在扩展自定义的错误处理。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">比如下面这个 JSon 语法的错误：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">type SyntaxError struct {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    msg    string // description of error</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    Offset int64  // error occurred after reading Offset bytes</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">func (e *SyntaxError) Error() string { return e.msg }</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">在使用上会是这个样子:</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">if err := dec.Decode(&amp;val); err != nil {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if serr, ok := err.(*json.SyntaxError); ok {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        line, col := findLine(f, serr.Offset)</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        return fmt.Errorf("%s:%d:%d: %v", f.Name(), line, col, err)</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    return err</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">上面这个示例来自 Go 的官方文档 《</span><a href="https://blog.golang.org/error-handling-and-go" target="_blank" style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; font-family: &quot;PT Serif&quot;; line-height: 1.5em; color: rgb(6, 85, 136); text-decoration: none;">Error Handling and Go</a><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">》</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">多说一句，如果一个函数返回了多个不同类型的 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">error</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">，你也可以用下面这样的方式：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">if err != nil {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    switch err.(type) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        case *json.SyntaxError:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">            ...</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        case *ZeroDivisionError:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">            ...</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        case *NullPointerError:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">            ...</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        default:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">            ...</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">但即便像 Go 这样的语言能让错误处理语义更清楚，而且还有可扩展性，也有其问题。如果写过一段时间的 Go 语言，你就会明白其中的痛苦—— </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">if err != nil</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的语句简直是写到吐，只能在 IDE 中定义一个自动写这段代码的快捷键……而且，正常的逻辑代码会被大量的错误处理打得比较凌乱。</span></div><h1 style="background-color: transparent; margin: 0px 0px 20px; padding: 0px; border: 0px; text-align: left; vertical-align: baseline; font-size: 35px;"><span style="font-size: 35px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 35px; font-weight: normal;">资源清理</span></h1><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">程序出错时需要对已分配的一些资源做清理，在传统的玩法下，每一步的错误都要去清理前面已分配好的资源。于是就出现了 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">goto fail</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的错误处理模式。如下所示：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">#define FREE(p) if(p) { \</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">                    free(p); \</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">                    p = NULL; \</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">                 }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">main()</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">{</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    char *fname=NULL, *lname=NULL, *mname=NULL;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    fname = ( char* ) calloc ( 20, sizeof(char) );</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if ( fname == NULL ){</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        goto fail;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    lname = ( char* ) calloc ( 20, sizeof(char) );</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if ( lname == NULL ){</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        goto fail;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    mname = ( char* ) calloc ( 20, sizeof(char) );</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if ( mname == NULL ){</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        goto fail;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ......</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">fail:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    FREE(fname);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    FREE(lname);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    FREE(mname);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ReportError(ERR_NO_MEMORY);</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">} </span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">这样的处理方式虽然可以，但是会有潜在的问题。最主要的一个问题就是——你不能在中间的代码中有 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">return</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 语句，因为你需要清理资源。在维护这样的代码时需要非常小心，因为一不注意就会导致代码有资源泄漏的问题。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">于是，C++ 的 RAII（Resource Acquisition Is Initialization）机制使用面向对象的特性可以容易地处理这个事情。RAII 其实使用 C++ 类的机制，在构造函数中分配资源，在析构函数中释放资源。下面看个例子。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">我们先看一个不好的示例：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">std::mutex m;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">void bad() </span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">{</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    m.lock();                    // 请求互斥</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    f();                         // 若 f() 抛异常，则互斥绝不被释放</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if(!everything_ok()) return; // 提早返回，互斥绝不被释放</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    m.unlock();                  // 若 bad() 抵达此语句，互斥才被释放</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">上面这个例子，在函数的第三条语句中提前返回了，导致 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">m.unlock()</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 没有被调用，这样会引起死锁问题。我们来看一下用 RAII 的方式是怎样解决这个问题的。</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">// 首先，先声明一个 RAII 类，注意其中的构造函数和析构函数</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">class LockGuard {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">public:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    LockGuard(std::mutex &amp;m):_m(m) { m.lock(); }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ~LockGuard() { m. unlock(); }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">private:</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    std::mutex&amp; _m;</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">// 然后，我们来看一下，怎样使用的</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">void good()</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">{</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    LockGuard lg(m);                 // RAII 类：构造时，互斥量请求加锁</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    f();                             // 若 f() 抛异常，则释放互斥</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if(!everything_ok()) return;     // 提早返回，LockGuard 析构时，互斥量被释放</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}                                    // 若 good() 正常返回，则释放互斥</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">在 Go 语言中，使用</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">defer</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">关键字也可以做到这样的效果。参看下面的示例：</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">func Close(c io.Closer) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    err := c.Close()</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if err != nil {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        log.Fatal(err)</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">func main() {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    r, err := Open("a")</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if err != nil {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        log.Fatalf("error opening 'a'\n")</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    defer Close(r) // 使用 defer 关键字在函数退出时关闭文件。</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    r, err = Open("b")</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    if err != nil {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">        log.Fatalf("error opening 'b'\n")</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    }</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    defer Close(r) // 使用 defer 关键字在函数退出时关闭文件。</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">从上面这三个例子来看，不同语言的错误处理，你喜欢哪个？就代码的易读和干净而言，我更喜欢 C++ 的 RAII 模式，然后是 Go 的 defer 模式，最后才是 C 语言的 goto fail 模式。</span></div><h1 style="background-color: transparent; margin: 0px 0px 20px; padding: 0px; border: 0px; text-align: left; vertical-align: baseline; font-size: 35px;"><span style="font-size: 35px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 35px; font-weight: normal;">异常捕捉处理</span></h1><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">上面，我们讲了错误检查和程序出错后对资源的清理这两个事。能把这个事做得比较好的其实是 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">try - catch - finally</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这个编程模式。</span></div><div style="background-color: rgb(243, 242, 238); margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; width: auto; font-size: 0.875em;"><div><code style="margin: 0px; padding: 0px; border: 0px; vertical-align: baseline; font-size: 1.15em;"><div><br/></div><table style="padding: 0px; border-spacing: 0px; border-collapse: collapse; margin: 0px; border: 0px; vertical-align: baseline; font-size: 1em;"><colgroup><col/><col/></colgroup><tbody style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">try {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ... // 正常的业务代码</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">} catch (Exception1 e) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ... // 处理异常 Exception1 的代码</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">} catch (Exception2 e) {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ... // 处理异常 Exception2 的代码</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">} finally {</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">    ... // 资源清理的代码</span></div></td></tr><tr style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><td style="margin:0px;border:0px;font:inherit;padding:0.25em 0.25em 0.25em 0.4em;vertical-align:top;"/><td style="margin: 0px; border: 0px; font-size: inherit; padding: 0.25em 0.25em 0.25em 0.4em; vertical-align: top;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 1em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">}</span></div></td></tr></tbody></table><div><br/></div></code></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em;">复制代码</span></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">把正常的代码、错误处理的代码、资源清理的代码分门别类，看上去非常干净。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">有一些人明确表示不喜欢 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">try - catch</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这种错误处理方式，比如著名的 </span><a href="https://www.joelonsoftware.com/2005/05/11/making-wrong-code-look-wrong/" target="_blank" style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; font-family: &quot;PT Serif&quot;; line-height: 1.5em; color: rgb(6, 85, 136); text-decoration: none;">Joel Spolsky</a><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">但是，我想说一下，</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">try - catch - finally</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的异常处理方式有如下一些好处。</span></div><ul style="background-color: transparent; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">函数接口在 input（参数）和 output（返回值）以及错误处理的语义是比较清楚的。</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">正常逻辑的代码可以与错误处理和资源清理的代码分开，提高了代码的可读性。</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">异常不能被忽略（如果要忽略也需要 catch 住，这是显式忽略）。</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">在面向对象的语言中（如 Java），异常是个对象，所以，可以实现多态式的 catch。</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">与状态返回码相比，异常捕捉有一个显著的好处是，函数可以嵌套调用，或是链式调用。比如：</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">int x = add(a, div(b,c));</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 或 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">Pizza p = PizzaBuilder().SetSize(sz) .SetPrice(p)...;</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 在需要返回码的情况下，这事儿有点难做。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">当然，你可能会觉得异常捕捉对程序的性能是有影响的，这句话也对也不对。原因是这样的。</span></div><ul style="background-color: transparent; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">异常捕捉的确是对性能有影响的，那是因为一旦异常被抛出，函数也就跟着 return 了。而程序在执行需要处理函数栈上的上下文，这会导致性能变得很慢，尤其是函数栈比较深的时候。</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">但从另一方面来说，异常的抛出基本上表明程序的错误。程序在绝大多数情况下，应该是在没有异常的情况下运行的，所以，有异常的情况应该是少数的情况，不会影响正常处理的性能问题。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">总体而言，我还是觉得 </span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">try - catch - finally</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 这样的方式是很不错的。而且这个方式比返回错误码在诸多方面都更好。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">但是，</span><span style="font-size: 0.875em; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.71429em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">try - catch - finally</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;"> 有个致命的问题，那就是在异步运行的世界里的问题。try 语句块里的函数运行在另外一个线程中，其中抛出的异常无法在调用者的这个线程中被捕捉。这个问题就比较大了。</span></div><h1 style="background-color: transparent; margin: 0px 0px 20px; padding: 0px; border: 0px; text-align: left; vertical-align: baseline; font-size: 35px;"><span style="font-size: 35px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 35px; font-weight: normal;">错误返回码 vs 异常捕捉</span></h1><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">是返回错误状态，还是用异常捕捉的方式处理错误，可能是一个很容易引发争论的问题。有人说，对于一些偏底层的错误，比如：空指针、内存不足等，可以使用返回错误状态码的方式，而对于一些上层的业务逻辑方面的错误，可以使用异常捕捉。这么说有一定道理，因为偏底层的函数可能用得更多一些。但是我并不这么认为。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">前面也比较过两者的优缺点，总体而言，似乎异常捕捉的优势更多一些。但是，我觉得应该从场景上来讨论这个事才是正确的姿势</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">要讨论场景，我们需要先把要处理的错误分好类别，这样有利于简化问题。</span></div><div style="margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; background-color: rgb(255, 250, 165);-evernote-highlight:true;">因为，错误其实是很多的，不同的错误需要有不同的处理方式。但错误处理是有一些通用的规则的。为了讲清这个事，我们需要把错误来分个类。我个人觉得错误可以被分成三个大类。</span></div><ul style="padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">资源的错误</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。当我们的代码去请求一些资源时导致的错误，比如打开一个没有权限的文件，写文件时出现的写错误，发送文件到网络端发现网络故障的错误，等等。</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">这一类错误属于程序运行环境的问题。对于这类错误，有的，我们可以处理，有的我们则无法处理。比如，内存耗尽、栈溢出或是一些程序运行时关键性资源不能满足时，我们只能停止运行，甚至退出整个程序。</span></span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">程序的错误</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。比如：空指针、非法参数等。</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">这类是我们自己程序的错误，我们要记录下来，写入日志，最好触发监控系统报警</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。</span></span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">用户的错误</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。比如：Bad Request、Bad Format 等这类由用户的不合法输入带来的错误。</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">这类错误基本上是在用户的 API 层上出现的问题</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">。比如，解析一个 XML 或 JSon 文件，或是用户输入的字段不合法之类的。</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">对于这类问题，我们需要向用户端报错，让用户自己处理修正他们的输入或操作。然后，我们正常执行，但是需要做统计，统计相应的错误率，这样有利我们改善软件或是侦测是否有恶意的用户请求。</span></span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">我们可以看到，这三类错误中，有些是我们希望杜绝发生的，比如程序的 Bug，有些则是我们杜绝不了的，比如用户的输入。而对于程序运行环境中的一些错误，则是我们希望可以恢复的。也就是说，我们希望可以通过重试或是妥协的方式来解决这些环境的问题，比如重建网络连接，重新打开一个新的文件。</span></div><div style="margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; background-color: rgb(255, 250, 165);-evernote-highlight:true;">所以，是不是我们可以这样来在逻辑上分类：</span></div><ul style="padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; background-color: rgb(255, 250, 165);-evernote-highlight:true;">对于我们并不期望会发生的事，我们可以使用异常捕捉；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; background-color: rgb(255, 250, 165);-evernote-highlight:true;">对于我们觉得可能会发生的事，使用返回码。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">比如，如果你的函数参数传入的对象不是一个 null 对象，那么，一旦传入后，可以抛异常，因为我们并不期望总是会发生这样的事。而对于一个需要检查用户输入信息是否正确的事，比如：电子邮箱的格式，我们用返回码可能会好一些。所以，对于上面三种错误的种类来说，程序中的错误，可能用异常捕捉会比较合适；用户的错误，用返回码比较合适；而资源类的错误，要分情况，是用异常捕捉还是用返回值，要看这事是不应该出现的，还是经常出现的。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">当然，这只是一个大致的实践原则，并不代表所有的事都需要符合这个原则。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">除了用错误的分类来判断是否用返回码还是用异常捕捉之外，我们还要从程序设计的角度来考虑哪种情况下使用异常捕捉更好，哪种情况下使用返回码更好。因为异常捕捉在编程上的好处比函数返回值好很多，所以很多使用异常捕捉的代码会更易读也更健壮一些。而返回码容易被忽略，所以，使用返回码的代码需要做良好的测试才能得到更好的质量。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">不过，我们也要知道，在某些情况下，你只能使用其中的一个，比如：</span></div><ul style="background-color: transparent; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; margin: -1em 0px 1.5em 1.5em; list-style: disc outside none;"><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">在 C++ 重载操作符的情况下，你就很难使用错误返回码，只能抛异常；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">异常捕捉只能在同步的情况下使用，在异步模式下，抛异常这事就不行了，需要通过检查子进程退出码或是回调函数来解决；</span></div></li><li style="margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; list-style-type: inherit; list-style-position: outside;"><div><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">在分布式的情况下，调用远程服务只能看错误返回码，比如 HTTP 的返回码。</span></div></li></ul><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">所以，在大多数情况下，我们会混用这两种报错的方式，有时候，我们还会把异常转成错误码（比如 HTTP 的 RESTful API），也会把错误码转成异常（比如对系统调用的错误）。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">总之，</span><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em; font-weight: bold; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">“报错的类型” 和 “错误处理” 是紧密相关的，错误处理方法多种多样，而且会在不同的层面上处理错误。有些底层错误就需要自己处理掉（比如：底层模块会自动重建网络连接），而有一些错误需要更上层的业务逻辑来处理（比如：重建网络连接不成功后只能让上层业务来处理怎么办？降级使用本地缓存还是直接报错给用户，等等）。所以，不同的错误类型再加上不同的错误处理会导致我们代码组织层面上的不同，从而会让我们使用不同的方式（也就是说，使用错误码还是异常捕捉主要还是看我们我们的错误处理流程以及代码组织怎么写会更清楚）。</span></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">通过学习今天的内容，你是不是已经对如何处理程序中的错误，以及在不同情况下怎样选择错误处理方法，有了一定的认知和理解呢？然而，这些知识和经验仅在同步编程世界中适用。因为在异步编程世界里，被调用的函数是被放到另外一个线程里运行的，所以本文中的两位主角，不管是错误返回码，还是异常捕捉，都难以发挥其威力。那么异步编程世界中是如何做错误处理的呢？我们将在下篇文章中讨论。同时，还会讲讲我在实战中总结出来的错误处理最佳实践。</span></div><p style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; vertical-align: baseline;"/><div style="background-color: transparent; margin: 1em 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; text-align: center;"><img src="images/%E6%9E%81%E5%AE%A2-fcc761001867c60f526665e237f831e9.jpg" height="535" width="1082"/><br/></div><p style="background-color: transparent; margin: 0px; padding: 0px; border: 0px; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; vertical-align: baseline;"/></div></div></div><div style="background-color: transparent; margin: 0px 0px 1.5em; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; position: absolute; top: -1000px; left: -1000px;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1.5em;">Measure</span></div><div style="background-color: transparent; margin: 0px; padding: 0px; border: 0px; font-size: inherit; vertical-align: baseline; position: absolute; top: -1000px; left: -1000px;"><span style="font-size: 16px; color: rgb(31, 9, 9); font-family: &quot;PT Serif&quot;; line-height: 1;">Measure</span></div></div></div></div></div></div></div></div><div><br/></div></body></html>