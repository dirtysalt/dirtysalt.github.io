# Chapter 1: Windows NT的黑色幽默与操作系统之路

在微软的传奇工程师戴夫·普拉默（Dave Plummer）的店里，他有幸迎来了一位真正的行业巨擘——戴夫·卡特勒（Dave Cutler）。卡特勒，这位81岁高龄却依然活跃在代码前线的微软高级技术院士，不仅是当今Windows操作系统的首席架构师和设计师，更是连续成功设计了RSX-11、VMS和Windows三款操作系统的传奇人物。他的成就斐然，曾荣获2007年国家技术与创新奖章，并在2016年被计算机历史博物馆授予院士称号。尽管头衔显赫，普拉默却发现卡特勒一如既往地平易近人，就像当年他还是“戴夫C.”，自己老板的老板的老板时一样。

访谈伊始，普拉默便抛出了一个流传已久的趣闻：Windows NT首次发布时，团队曾给Sun公司送去一份“特别礼物”。卡特勒笑着揭开了这个尘封已久的秘密。原来，当时Sun公司的斯科特·麦克尼利（Scott McNealy）和IBM的李·赖斯维格（Lee Reiswig）都曾对微软出言不逊。于是，团队中的某人（可能是行政助理凯利·威尔逊）找到了两英尺长的黑色硬纸板棺材。他们决定给麦克尼利和赖斯维格各送去一个，里面还藏着“惊喜”。一位同事找到了一种会播放“死亡进行曲”的生日卡片，将其放入棺材。更绝的是，考虑到麦克尼利曾让Sun公司的吉祥狗“网络”（Network）在一只写着“Microsoft”的消防栓上撒尿，团队特意在给麦克尼利的棺材里放了些假狗屎，以及一份SunOS或其他Sun操作系统的零售版许可证。这些“礼物”都是专人手递，确保送达。

这个恶作剧还被全程录像，打算在周五的WIM（Windows内部会议）上播放。当时，一位名叫奥尔顿的经理偶然看到录像，兴奋不已，甚至想在卡片上签名。然而，就在周三，比尔·盖茨发布了一份全公司范围的备忘录，要求大家“从现在开始做个好人”，不要贬低竞争对手。周四，奥尔顿无奈地告诉卡特勒，录像不能播放，棺材也不能送了。卡特勒却淡定地回答：“哎呀，真不巧，吉姆，我们已经送出去了！”就这样，这些充满黑色幽默的“礼物”还是成功送达了。这段珍贵的录像，后来在Windows NT的21周年庆典上重见天日，让普拉默也得以一睹为快。

话题转向卡特勒的职业生涯早期，他坦言自己并非一开始就投身操作系统。在斯科特纸业公司的工作并不令人满意，他负责的纸机模型项目，客户并不真正关心。后来，他的老板去了联合碳化物公司，卡特勒也前去面试，甚至被派往印第安纳州的科科莫——一个生产潜艇用耐腐蚀钢材的地方，他形容那里“糟透了”。与此同时，他也面试了杜邦公司的工程部门。杜邦公司自行设计建造所有化工厂，以保守秘密并确保质量。他们有一个实时系统小组，为工厂构建实时系统。卡特勒最初接受了科科莫的工作，但一周后发现杜邦的薪资远超预期。他毅然退掉了科科莫的offer，庆幸自己没有成为一名COBOL程序员，否则可能至今仍在科科莫。

在杜邦的实时系统小组，卡特勒首先参与了纺织纤维厂的项目，并负责自动化Instron拉伸测试的分析。Instron是一种用于拉伸材料并测量其屈服点等数据的机器。他编写了一个实时程序，每100毫秒收集一次数据。然而，作为工程服务部门，项目需要等待，这让卡特勒感到无聊。他发现隔壁有一台1107计算机，由三个人维护。他主动请缨，开始参与1107的操作系统Exec 2的开发。那是一个批处理系统，速度极快。每天晚上五点，他们会赶走操作员，独占机器两小时，进行实验和代码测试。在没有调试器的年代，他们只能通过1107上的各种开关来调试，这种亲身实践的经验，为他后来设计VMS系统奠定了基础。

随后，卡特勒又回到了实时系统小组，为实验站构建了一个更大型的Instron分析系统。他们采用了一个双PDP-10系统，共享32K字内存，并用PDP-8作为前端处理终端输入。两台PDP-10一台运行TOPS-10，另一台运行他们自己开发的系统，通过共享内存和双中断机制高效交换数据。正是这些在杜邦的经历，最终将卡特勒引向了数字设备公司（Digital），在那里，他立即投身于RSX-11C操作系统的开发，尽管最初他被雇佣是为了一个名为OS45的“梦想项目”。

# Chapter 2: 从双机系统到VMS的诞生：卡特勒在Digital的早期挑战与创新

戴夫·卡特勒在杜邦公司完成了双PDP-10系统的开发后，带着丰富的经验和对操作系统开发的热情，毅然决然地加入了Digital公司。他此行的目的非常明确：投身于操作系统的研发。

刚到Digital，卡特勒就被分配到了一个名为OS45的项目。这个项目由一位麻省理工学院毕业、曾参与Multics开发的戴夫·斯通主导，他怀揣着宏伟的愿景，希望在全新的PDP-11/45计算机上构建一个类似Multics的系统。PDP-10是微秒级机器，而PDP-11/45则快了三倍，达到了300纳秒级，这让斯通对新系统充满了信心。PDP-10在当时是分时系统的宠儿，深受大学和分时服务机构的喜爱，斯通希望PDP-11/45也能复制这一成功。然而，他忽略了一个致命的缺陷：PDP-11的16位地址空间，这在操作系统架构中是一个巨大的限制。OS45的设想是包含实时、批处理和分时子系统，听起来颇有些IBM 360系统复杂多样的操作系统风格。

与此同时，Digital的工业项目组（IPG）正为另一个项目焦头烂额——RSX-11C。这个项目已经进行了两年，目标仅仅是让PDP-11实现终端仿真。项目的首席架构师是一位来自Foxborough（一家过程控制公司，而非新英格兰爱国者队的主场）的工程师，他可能擅长过程控制硬件，但在操作系统设计方面却显得力不从心。卡特勒回忆说，RSX-11C的代码量可能不超过一万行，但两年多来进展缓慢，IPG团队已近绝望。他们找到卡特勒，问他是否愿意在业余时间帮忙。卡特勒欣然应允，尽管他后来坦言，他参与开发的RSX-11C“糟糕透顶”，甚至只能“控制你的门铃”，远不能满足现代客户的需求。

在RSX-11C的泥沼中挣扎了一年左右，卡特勒开始转向更具前瞻性的VMS项目。VMS的开发环境颇具特色。VAX处理器拥有PDP-11模式，这使得VMS团队能够利用RSX-11M的现有工具和实用程序，就像后来的Windows WOW64层一样，在VAX上运行PDP-11程序。早期的VMS核心开发，如调度和内存管理，是在一个微码硬件模拟器上进行的，虽然不快，但足以支持最初的探索性工作。

开发工具链也很有趣：汇编器运行在16位的RSX-11M系统上，生成32位的可重定位代码；而链接器则运行在PDP-10上，用一种名为BLISS的语言编写。BLISS是卡内基梅隆大学发明的一种“无goto”语言，以其严格的L值/R值区分和显式解引用（每个变量前都需加点号）而闻名，但它也因容易出错而未能普及。调试器同样是用BLISS在PDP-10上开发的。除了链接器和调试器，大部分开发工作都在RSX-11M系统上进行，特别是在PDP-11/70上，一台拥有64KB内存的机器竟然能同时支持十几个用户运行编译器和链接器，这在今天看来简直不可思议。

随着VMS原型机（Proto Three，后来可能是Proto Six）的出现，卡特勒团队采取了“自食其果”（eat our own dog food）的策略。一旦系统足够稳定，他们就将开发环境迁移到原型机上。卡特勒生动地描述了当时的场景：办公室和机器分开放置，一旦系统崩溃，三四个人就会起身走到机器旁，在调试器前坐下，找出问题，重启系统，回到办公室修复bug，更新系统，再重启，周而复始。这种紧密的开发模式，虽然辛苦，却也无形中提升了系统的质量。

VMS的发布伴随着一个传奇的说法：“零已知bug”。卡特勒澄清说，这并不意味着没有bug，而是所有已知的bug在发布前都得到了修复。他痛恨那些带着数万已知bug却仍被项目经理批准发布的系统。VMS团队付出了巨大的努力，甚至在最后一刻修复了一个磁盘驱动器中的竞态条件bug。VMS的开发是受硬件销售驱动的，因为Digital公司的成功在于销售硬件，而没有操作系统，硬件就无法销售。

为了加速开发和测试，Digital还实施了早期采用者计划，将VMS原型机提供给两家关键客户：一家是斯伦贝谢（Schlumberger），他们将VAX安装在半挂卡车上，在美国各地收集油井数据；另一家是与海军相关的机构。Digital在每家客户那里都派驻了两名软件支持专家，负责接收和部署系统更新。VMS的开发遵循“基线级别”模式，团队会设定阶段性功能目标，只有达到当前基线，才会进入下一个阶段。

# Chapter 3: 从VMS到编译器，再到西雅图的Vaxilon新篇章

VMS的成功发布，让戴夫·卡特勒和他的团队看到了努力的成果。斯伦贝谢和某个海军机构是VMS的首批重要客户，Digital公司在每个客户现场都派驻了两名软件支持专家，负责系统的更新与维护。与微软开发团队每天更新的频率不同，VMS的更新遵循“基线”原则——预设的功能里程碑，只有达到这些基线，团队才会推进到下一个阶段。VMS系统在内部开发中运行了一年多，表现出足够的稳定性和可靠性，即使有二三十名工程师在改进后的CRT终端上敲击键盘，系统也鲜少崩溃。卡特勒回忆起那些不再需要“一磅力”才能按下的键盘，不禁感叹技术的进步。

VMS项目第一版发布后，卡特勒对编译器背后的“魔力”产生了浓厚兴趣。恰逢Digital公司的一个商业部门需要PL/I编译器，而Fortran和COBOL等语言团队对此不感兴趣，这给了卡特勒一个机会。他们从波士顿一家公司（由鲍勃·费伯豪斯创立）购买了一个PL/I子集的前端，而卡特勒则负责开发后端，包括代码生成器。前端将代码编译成一种中间语言，这是现代编译器普遍采用的多阶段处理方式。开发过程颇具挑战性：后端在VAX上完成，而前端的工作则在麻省理工学院的Multics系统上进行。由于从特克斯伯里远程连接Multics速度奇慢，几乎无法使用，团队不得不采取一种原始却有效的方式——“磁带穿梭”。他们会在麻省理工学院的系统上完成前端工作，然后将数据写入磁带，驱车十英里将磁带带回特克斯伯里，再读取磁带，将其输入到VAX上的后端，最终生成可执行的目标代码。

基于相同的后端，团队还开发了C编译器。这个后端虽然高效，但卡特勒坦言它并不“优雅”，其中大量代码是用一种名为TBL（Table的缩写）的字节解释器语言编写的。TBL利用字节码和隐含操作数，以极高的函数调用密度处理各种数据记录和变量引用。卡特勒对代码优化情有独钟，这源于他对CSC为1108编写的Fortran编译器所产生“难以置信的优秀代码”的深刻印象。他投入了大量时间研究优化和寄存器分配技术，力求让代码运行得更快、更高效。

然而，到了1980年左右，卡特勒开始感到Digital公司日益增长的官僚主义带来的束缚。公司从一个工程师为工程师打造产品的纯粹环境，逐渐演变为一个被商业计划和利润驱动的复杂组织，偏离了创始人肯·奥尔森“为客户做正确的事”的初衷。他渴望摆脱这种环境。此时，一位同事向他介绍了一位来自劳伦斯利弗莫尔国家实验室的工程师，此人曾参与“湿婆新星”（Shiva Nova）激光核聚变项目，并主导开发了一种名为Praxis的专用语言来控制激光。这位工程师计划利用政府资助的Praxis语言创办一家编译器公司。卡特勒被说服，与Digital的四名同事以及对方公司的两名成员一同加入了这个新 venture。

卡特勒的离职意向让Digital的传奇人物戈登·贝尔大为震惊，他竭力挽留，询问卡特勒需要什么才能留下。卡特勒坦言，他需要远离马萨诸塞州的官僚气息，希望在一个更偏远的地方工作。然而，这家初创公司很快就陷入困境。公司总裁将他们每人投入的2500美元（总计7500美元）全部用于支付他妻子经营的书法公司制作名片，这让卡特勒怒不可遏，他当即决定退出。

初创公司的失败让卡特勒重新回到了Digital的怀抱。戈登·贝尔再次找到他，并承诺他可以选择任何地方工作，唯一的条件是必须靠近一所大学。卡特勒明确表示了一些不愿去的地区：东南地区、华盛顿特区周边、他长大的美国中部，以及凤凰城。他倾向于西南或西海岸。于是，Digital组织了一个团队，包括房地产专家，一同前往西海岸考察潜在地点。萨克拉门托和圣罗莎都被排除。卡特勒对波特兰印象不错，但最终，当他们飞抵西雅图时，那里的景色深深吸引了他。雨中的西雅图，如同爱尔兰般拥有无数层次的绿色，美不胜收。他当即决定，这里就是他们新工程组织的所在地。

在西雅图的贝尔维尤，卡特勒和大约12名同事成立了一个新的工程团队，毗邻华盛顿大学。他们的任务是开发基于芯片的系统软件，以应对当时刚刚兴起的超大规模集成电路（VLSI）技术。Digital公司设想未来将普及廉价的单芯片设备（如传真机），而他们需要为这些设备提供运行软件。这个项目被命名为Vaxilon。尽管Vaxilon最终并非一个“非常好的系统”，但它成为了一个重要的试验平台，团队在其中尝试了许多前所未有的创新理念，例如用户模式驱动程序、完全面向消息的通信机制（发送方取消映射，接收方映射），以及多线程和多处理器支持。这是他们首次尝试构建多处理器、多线程的系统。

卡特勒从RSX-11M和VMS中异步系统调用（ASTs/APCs）给客户带来的困扰中吸取了教训，决定在Vaxilon中更好地控制系统行为。他们引入了大量的用户模式调度器控制，允许禁用上下文切换，甚至可以保证程序中不会同时运行两个线程。然而，讽刺的是，客户很快就抱怨为何不允许他们运行多个线程。尽管如此，Vaxilon系统还是成功交付给了少数客户，其中之一是Cadex公司，它是Aldus（PageMaker的开发者）的一个分支，当时正在开发一种文档控制系统。Vaxilon的开发，为卡特勒和团队在未来更复杂的系统设计中积累了宝贵的经验。

# Chapter 4: 从Vaxilon到Prism的终结：卡特勒的职业转折与微软的召唤

戴夫·卡特勒在西雅图领导的Vaxilon项目，致力于探索芯片级系统软件的未来。这个系统拥有一些独特而大胆的设计理念，例如允许禁用上下文切换，甚至能保证程序在任何时候都只运行一个线程。尽管这些特性在当时看来有些激进，甚至在发布后立刻引来了用户“为何不允许多线程”的疑问，但Vaxilon系统最终还是成功交付并拥有了一些客户。其中一家名为Cadex的公司，是著名桌面出版软件Pagemaker的开发商Aldus的子公司，他们利用Vaxilon构建了一个文档控制系统，卡特勒团队也与他们紧密合作。

然而，在Vaxilon项目进行到一半时，卡特勒团队发现Digital公司内部竟然没有一款单芯片的VAX处理器。这让他们意识到市场对小型、廉价VAX的需求，于是公司启动了MicroVAX项目。卡特勒在DEC West（Digital在西雅图的研发中心）亲自操刀，为第一代MicroVAX 1.0编写了全部微代码。那是一段难忘的经历，他至今仍对没有保留那份4K x 40位（由五块8位PROM组成）的微代码副本感到遗憾。MicroVAX 1.0成功发布后不久，真正的单芯片VAX——MicroVAX 2.0也应运而生，标志着这一阶段的圆满。

卡特勒还解释了微代码的奥秘：它并非用户直接操作的指令集，而是微处理器内部的控制指令。VAX的指令集对程序员来说是统一的，但所有VAX处理器，包括早期的VAX 780（其微指令宽度高达99或100位），都是通过微代码实现的。宽微指令的设计旨在避免垂直编码字段的解码，允许直接将位模式送入硬件，从而实现更高的并行度和更精细的硬件控制。

在MicroVAX项目之后，卡特勒的职业生涯再次面临转折。他的一位老朋友，曾是VAX 750的项目经理，后来去了Intel参与备受争议的432项目。这位朋友试图邀请卡特勒加入Intel，尽管不是432团队，而是负责RMX-16实时操作系统（为286处理器设计）的团队。卡特勒欣然前往波特兰面试，一切进展顺利，Intel准备向他发出录用通知。然而，在最后一刻，Intel提出一个条件：卡特勒必须告知戈登·贝尔他正在寻找新工作并在Intel面试，因为Intel与Digital保持着良好的合作关系。

卡特勒毫不犹豫地答应了。他在新罕布什尔州的纳舒厄拿起电话，拨通了戈登·贝尔的号码，坦诚地告知他正在Intel面试并可能收到工作邀约。他向贝尔解释，自己并非真的想跳槽，只是想了解自己在市场上的价值。贝尔对此表示理解。然而，仅仅15分钟后，卡特勒就接到了Digital软件工程副总裁拉里·波特纳的电话，邀请他与贝尔共进午餐。午餐时，卡特勒再次表达了他的不满：在VAX/VMS项目上，他每周工作七天，每天十小时，付出了巨大的努力，但最终获得的奖励（一万股股票）与VAX的巨大成功和公司因此获得的收益相比，显得微不足道。贝尔和波特纳承认公司可能在这方面做得不够好，并表示不希望他接受Intel的邀约。最终，Digital确实提供了更多的股票，但卡特勒对Intel的印象并不深刻，而且他内心深处渴望离开纳舒厄。这次事件促成了他最终搬到DEC West。

在DEC West工作期间，Digital在80年代中期启动了Prism项目，旨在开发RISC架构。当时，RISC处理器因其易于构建（例如使用AMD的2901位片芯片）而备受追捧，并声称比CISC架构的VAX拥有两倍的性能优势。VAX之所以复杂，部分原因在于内存昂贵，需要将程序编码在与PDP-11相同的空间内，导致指令集难以解码。Digital内部有多个RISC项目，最终DEC West被选为架构的“守护者”，负责Prism项目。卡特勒像开发VAX架构时一样，邀请了来自硬件、软件等各个部门的代表参与，并开发了32位和64位两种架构版本。他们还着手开发了一个名为Mica的全新操作系统，其野心之大堪比Multics，尽管卡特勒认为即使建成也可能无人购买，但其中蕴含了许多优秀的设计理念。

然而，Prism项目进展缓慢，未能达到公司预期的速度。与此同时，MIPS处理器在RISC领域异军突起。Digital的研发副总裁萨姆·富勒和SGI的创始人之一福雷斯特·巴斯克特等人都强调，外部公司能够制造出比VAX更快的单芯片系统。最终，一位演讲者向肯·奥尔森（Digital创始人）展示了一份令他印象深刻的报告，第二天，Prism项目就被取消了。项目取消的第二天，卡特勒便辞去了Prism项目的工作，但他并未离开Digital，而是搬到了微软附近的一栋Digital大楼，准备创业。

他与三位前DEC West的同事计划成立一家服务器公司，并积极奔走于硅谷，与美林·皮肯斯、约翰·多尔（Oak Investments）等风险投资人洽谈，最终成功获得了启动资金。与此同时，一些前DEC West的同事已经跳槽去了微软，其中一人在内森·梅尔沃德手下工作。内森·梅尔沃德在比尔·盖茨面前很有影响力，他对RISC架构非常看好。更重要的是，微软当时在操作系统方面的软件产品相当“糟糕”，大部分都是用汇编语言编写，缺乏可移植性。正是在这样的背景下，卡特勒接到了微软的电话，邀请他与比尔·盖茨面谈一份工作。

# Chapter 5: 微软的召唤：从怀疑到NT的诞生

戴夫·卡特勒在Digital公司经历了一系列挑战后，对微软的操作系统软件现状早有耳闻——在他看来，那时的微软操作系统代码充斥着汇编语言，缺乏可移植性，简直“糟糕透顶”。然而，命运的齿轮开始转动，微软向他抛出了橄榄枝。在内森·梅尔沃德（Nathan Myhrvold）这位在比尔·盖茨耳边极力推崇RISC架构的智囊影响下，微软对未来操作系统的构想逐渐清晰。

一天，卡特勒接到了微软的电话，邀请他与比尔·盖茨面谈。他欣然前往，却发现比尔·盖茨开门见山，语气坚定地问：“你肯定会加入我们，对吧？”卡特勒则不以为然，回应道：“也许吧，也许不。”比尔·盖茨对此感到不可思议，追问：“怎么可能不加入我们？我们是世界上最棒的公司！”卡特勒只是静静地听着比尔的“推销”，并与罗布·肖特、约翰·贝尔丘纳斯和隆·威洛比等人进行了交流。然而，首次接触并未给他留下深刻印象，他坦率地表示：“我对微软并不那么看好。”

卡特勒的拒绝并未让微软放弃。不久，史蒂夫·鲍尔默亲自出马，邀请他周日早上八点在丹尼餐厅共进早餐。这次早餐会成为了转折点。鲍尔默以其非凡的口才和魅力，彻底说服了卡特勒和他的团队。卡特勒回忆道，那次谈话的效果立竿见影，仿佛就在周三，他们便已决定加入，而下周一，他们便正式入职了。鲍尔默的个人魅力和远见，让卡特勒至今仍视他为挚友和偶像。

加入微软后，卡特勒开始深入了解微软操作系统的发展历程。他了解到，微软曾通过巧妙的批量授权策略，将AT&T的Xenix许可证转售给其他公司，从中赚取了丰厚利润。随后，DOS在与CP/M的竞争中脱颖而出，成为IBM PC的首个操作系统。然而，DOS本质上只是一个程序加载器，功能有限。微软与IBM合作开发了16位的OS/2，并引入了新的HPFS文件系统，由戈登·莱特温用汇编语言编写。但这次合作却因IBM根深蒂固的官僚主义、僵化和规避风险的文化而举步维艰，两家公司在异地开发，效率低下。

正是在这种背景下，内森·梅尔沃德再次强调了RISC处理器的未来趋势，并指出16位系统已不足以应对挑战，而OS/2的不可移植性更是致命弱点。他力主微软应为RISC系统构建一个全新的操作系统。卡特勒在加入微软时，也明确提出了一个条件：他绝不与IBM直接合作，只允许他们对设计提出意见。他深知IBM的官僚作风会拖慢项目进度。

NT项目的初期目标是构建一个可移植、能支持多种环境（如OS/2、POSIX和Mach）的系统。团队设想通过一个提供核心服务的系统内核，再针对不同环境进行定制。尽管卡特勒后来承认这在某些方面（如线程调度、进程结构和分页）可能过于理想化，但这是他们最初的愿景。团队花费了六个月到一年的时间，撰写了两大卷详细的规范文档，其中一份甚至被史密森尼博物馆收藏。

与此同时，微软的Windows产品线也悄然崛起。Windows 1.0和2.0反响平平，但Windows 3.1却在六个月内售出1600万份，这让比尔·盖茨看到了其巨大的潜力，并决定将Windows作为新系统的主要环境。于是，NT的开发方向也随之调整，从最初的OS/2目标转向了Windows。有趣的是，NT的开发初期，团队甚至是在OS/2环境下进行的，他们迫不及待地希望尽快“自食其果”，摆脱OS/2。

关于“NT”的含义，曾有过一些误解。最初，它可能与英特尔的i860处理器（代号NTen）有所关联，但卡特勒明确指出，NT的真正含义是“New Technology”（新技术）。尽管市场和项目经理曾担心“新技术”会吓跑用户，认为没人会购买，但卡特勒坚持己见，最终赢得了这场争论，NT之名得以保留。

Windows NT的第一个版本（NT 3.1）支持了多种CPU架构，包括32位x86、MIPS（R3000和R4000）以及Alpha。PowerPC架构则在NT 3.5版本（代号Daytona）中加入。然而，PowerPC的适配过程充满了挑战。IBM作为其主要推动者，却因不愿自家产品线（如AIX和大型机）受到冲击，始终未能提供具有竞争力的PowerPC机器。此外，IBM的编译器也问题不断，导致PowerPC版本的NT构建每天都面临困难。最终，由于IBM无法提供一个真正有竞争力的系统，微软不得不放弃了对PowerPC的支持。

# Chapter 6: PowerPC的困境、NT架构的演进与团队的激情岁月

戴夫·卡特勒回忆起与IBM PowerPC合作的艰难岁月。IBM为了保护其AIX系统和大型机市场，始终不愿推出具有竞争力的PowerPC机器，生怕“自相残杀”。更糟糕的是，IBM提供的开发工具，尤其是编译器，总是问题不断。卡特勒的团队每天要进行四到五次构建（后来因为放弃R3000而稳定在四次），其中RISC架构（如MIPS和Alpha）和x86的构建都相当可靠，唯独PowerPC的构建，几乎每天都会失败。IBM的硬件更新换代频繁，每年一次，但始终无法达到有竞争力的水平，最终NT团队不得不放弃对PowerPC的支持。卡特勒指出，NT系统的架构设计本身对构建多平台版本并没有造成太大障碍，主要是IBM的工具和硬件问题。NT系统大部分代码是与机器无关的，机器相关的代码（如内存管理、中断处理等）只占一小部分，这使得跨平台移植相对容易。

谈到硬件抽象层（HAL），卡特勒解释说，HAL中大部分代码并非汇编语言。虽然有些频繁操作为了追求极致速度，在编译器表现不佳时会使用汇编，但从一开始，卡特勒就反对使用内联汇编，因为他曾目睹x86编译器在遇到内联汇编时会“举手投降”，放弃后续优化。因此，在64位开发中，他们倾向于使用“内在函数”（intrinsics），这使得HAL中的大部分机器特定操作都能用C语言结合内在函数来实现，大大减少了汇编代码的使用。他澄清说，中断处理等核心功能其实在内核中，而非HAL。HAL主要负责配置硬件，如x86/x64上的PCI空间和ARM的一些配置。最初，HAL被设计成独立的DLL，甚至希望由硬件厂商自行开发，作为“厂商抽象层”。然而，事实证明这是一个糟糕的主意，一些MIPS厂商尝试后效果不佳。如今，HAL已成为操作系统的一部分，可以直接构建进系统，而非独立的DLL。卡特勒坦言，如果当初能直接将其作为操作系统的一部分来构建，会省去很多麻烦，但当时为了支持不同厂商的硬件，必须保持其可插拔性。

接着，卡特勒回顾了视频驱动程序的演变。在NT 3.1初期，视频驱动程序运行在用户模式下，内核中有一个并行的跟踪线程。虽然这带来了一定的开销，并在Daytona版本中有所优化，但卡特勒最初反对将其移入内核模式，他担心负责图形和用户界面（User32）的开发人员无法编写高质量的内核代码。事实证明他的担忧并非没有道理。当视频驱动最终被移入内核模式时，团队发现许多在用户模式下不成问题的地方，在内核模式下却引发了同步问题。在内核模式下，一切都是并行的，需要显式的同步机制，而在用户模式下，如果知道自己是唯一的线程，就可以安全地假设这一点。此外，那些“腐朽”的16位代码，包括16位数据结构和原语，也随之被带入内核，增加了移植的复杂性。尽管经历了诸多磨砺，视频驱动最终在可靠性上取得了显著提升。卡特勒也提到，长期以来，第三方显卡驱动（如NVIDIA）一直是系统稳定性的痛点，曾有驱动被报告数万个bug，平均每天半天就会导致系统崩溃，但这些问题后来也得到了改善。

除了技术挑战，卡特勒还分享了团队建设的趣事。当他刚加入微软时，团队迅速扩张，为了让新成员彼此认识，网络组负责人戴夫·汤姆森提出了“每周集成会议”（WIMs）的想法。每周五下午，卡特勒手下的五位经理会去超市采购啤酒、薯片、虾等，然后开放一个硬件实验室，邀请所有成员前来聚会。这个活动大受欢迎，从最初的小房间发展到接待区，甚至后来由万豪酒店提供餐饮服务。从WIMs开始到NT 3.1发布，几乎每个周五晚上都会举行。卡特勒特别提到，这与扎卡里·帕斯卡（Zachary Pascal）书中描绘的“死亡行军”和“折磨员工”的形象截然不同，WIMs正是团队每周努力放松、缓解压力的体现。

最后，卡特勒还透露了他对赛车运动的热爱。NT 3.1发布后，史蒂夫·伍德（Steve Wood）提议大家去拉古纳塞卡赛道参加赛车驾驶课程。约15人报名参加了为期四天的方程式福特赛车课程，但这些赛车速度慢、操作笨重，并不令人兴奋。随后，他们又参加了马自达引擎驱动的赛车课程，这些赛车速度可达130英里/小时，更具挑战性和满足感。卡特勒发现，赛车需要高度的专注和练习，它能让人完全沉浸其中，忘却日常烦恼，只专注于眼前的赛道和即将到来的弯道。这种极致的专注体验让他乐此不疲，最终他甚至参加了专业的赛车学校，体验了从练习到正式比赛的完整赛车周末。

# Chapter 7: 卡特勒的赛车传奇与NT的幕后风云

戴夫·卡特勒不仅是技术领域的巨匠，更是一位对速度充满激情的赛车手。他的赛车生涯始于一次偶然的发现——在完成了高级驾驶课程后，他得知赛车学校的存在。那是一个为期两天的赛车体验，通常包括周五的练习赛，以及周六和周日的正式比赛。卡特勒很快便沉迷其中，渴望追求更高的速度。他进而参加了“职业赛”，这种比赛使用相同的引擎，但移除了限速器，并对排气系统进行了改装，让赛车跑得更快。更重要的是，职业赛允许车手调整悬挂系统，而整个赛车项目也巧妙地与机械师培训学校结合，车手们不仅支付驾驶费用，也承担了所有可能发生的碰撞维修费用。

在职业赛中，卡特勒与一位名叫凯斯·蒙哥马利（Case Montgomery）的教练结下了深厚的友谊。蒙哥马利教练被一位曾参加过大西洋方程式赛车（一种开放式车轮的方程式赛车）的车手说服，决定购买一辆滞留在澳大利亚的赛车，并将其带回美国参加大西洋方程式系列赛。卡特勒被邀请参与其中，并最终买下了这辆赛车。1996年，蒙哥马利驾驶着这辆车参赛。次年，他们决定为蒙哥马利购买一辆新车，而那辆“旧”车（主要是车身空气动力学设计有所不同，引擎和变速箱保持不变）则留给了卡特勒。

当时的大西洋方程式系列赛分为两个级别：C系列和为“大奖金”而战的职业组。卡特勒决定亲自驾驶旧车尝试参赛。在凤凰城的火鸟赛道（位于印第安保留地，拥有两条赛道和一个直线加速赛道，邦杜兰特驾驶学校也设在此），他与经验丰富的蒙哥马利教练的单圈时间仅相差两秒。这一成绩让团队坚信他有能力参赛，于是，1997年，卡特勒的赛车生涯正式拉开帷幕。

在接下来的几年里，他参加了56场比赛，足迹遍布美国和加拿大，包括休斯顿的街道赛、佛罗里达的霍姆斯特德、宾夕法尼亚的拿撒勒、多伦多、蒙特利尔、三河城、温哥华、波特兰、拉古纳塞卡、长滩、中俄亥俄、圣路易斯、芝加哥，以及著名的密尔沃基英里椭圆赛道。卡特勒在椭圆赛道上表现出色，他幽默地指出，椭圆赛道车手只有两种：一种是还没撞墙的，另一种是已经撞过的，而前者迟早会变成后者。他自己也曾两次在圣路易斯和凤凰城的测试中遭遇严重撞车。

2002年，60岁的卡特勒在丹佛的百事可乐中心完成了他最后一场比赛。他意识到，虽然自己每年都在进步，但年轻的对手们进步得更快，他逐渐失去了竞争力。此外，赛车运动耗资巨大，时间投入也极其庞大——每年12场比赛，加上至少6个测试周末，意味着每周四出发，周日晚上才能回家。这种高强度、高投入的生活让他感到疲惫，最终选择了退役。

赛车之外，卡特勒在Windows NT的开发中也扮演着关键角色。他回忆起与鲍勃·戴（Bob Day）等人将Windows 95的用户界面移植到NT上的经历，这对于代号为“Tukwila”的项目至关重要，并最终帮助“扼杀”了代号为“Cairo”的另一个项目。Cairo项目是吉姆·奥尔钦（Jim Allchin）在加入微软后力推的宏大构想，旨在为NT构建全新的用户界面。然而，卡特勒和梅根·布利斯（Megan Bliss）成功说服奥尔钦，可以同时进行Tukwila和Cairo项目，声称他们有足够的资源。他们承诺每天优先构建Cairo，然后才是Tukwila。然而，现实却是Tukwila每天都能成功构建，而Cairo却总是问题不断，进展缓慢。Cairo的许多功能，特别是其文件系统OFS，因未能实现向后兼容性而最终被放弃。渐渐地，Cairo项目的功能未能按时交付，而Tukwila却不断壮大。最终，Cairo项目中真正被采纳的只有文件服务器软件和Kerberos协议，其余大部分都被彻底废弃。

卡特勒坦言，NT的开发过程比预期的三年要漫长。与VMS项目相比，VMS团队虽然只有20人，但每个人都是顶尖人才，而NT团队虽然核心成员优秀，但整体规模更大，人才密度不如VMS，且需要处理更多复杂任务。例如，他们最初计划只支持一种架构，但最终却在NT 3.1发布前支持了x86、MIPS等多种架构，并放弃了问题重重的Intel 860芯片——其勘误表厚达半英寸，甚至连Intel自己的异常处理程序都无法正常工作。

在NT开发过程中，压力巨大。卡特勒回忆起一个著名的事件：在一次关于调试器功能不完善、进展缓慢的激烈争论中，他一怒之下砸穿了墙壁。这个被裱起来的墙洞，成为了NT团队25周年纪念时的一个独特纪念品，也印证了当时开发环境的紧张与艰辛。

# Chapter 8: 卡特勒的怒吼与NT的重生：从墙洞到64位统一

在Windows NT的早期开发阶段，技术挑战层出不穷。当浮点运算出现问题时，团队曾寄希望于Intel的异常处理器，然而，事实证明，那个处理器本身就充满了漏洞，根本无法正常工作。正是在这样的技术泥沼中，Tukwila项目才得以脱颖而出，成功地将Windows 95的用户界面移植到NT 4.0，而备受期待的Cairo项目则黯然收场。

然而，技术上的困境并非唯一的压力源。在NT项目紧张的开发氛围中，戴夫·卡特勒的脾气也曾有过一次著名的爆发。那是在NT 25周年纪念活动上，有人提及了当年他怒砸墙壁的往事。卡特勒回忆道，那是在二号楼的走廊里，他正与布莱恩·威尔曼（Brian Willman）激烈争论调试器的问题。调试器功能不完善，开发进度缓慢，远未达到他期望的速度。当威尔曼说出某句话彻底激怒了他时，卡特勒猛地一拳砸向墙壁。幸运的是，他击中了金属立柱之间的石膏板，拳头直接穿透了墙壁。那个被砸穿的墙洞，后来甚至被团队裱起来，作为NT System52的“纪念品”，至今仍被卡特勒珍藏着，成为了那个时期巨大压力的生动写照。

尽管开发过程充满艰辛，NT的核心代码却展现出惊人的生命力。卡特勒估计，即使到了Windows 11时代，NT 3.5中约80%的核心功能代码依然存在。当然，系统在安全性、管理和构建方面增加了大量新功能，例如构建系统已经完全重写。内存管理模块虽然每隔三年就会被兰迪·王（Landy Wang）这样的工程师重写一次，但其基本结构和核心代码却始终如一。进程结构和内核也基本保持不变。卡特勒特别强调了对象管理器（Object Manager）的卓越设计，他认为这是NT成为优秀代码库的关键。与Unix“一切皆文件”的哲学不同，NT通过对象管理器可以轻松创建新对象，从而灵活地扩展操作系统功能，提供同步等多种服务。这种设计理念至今未变，并被证明是极其成功的。即使是看似微不足道的句柄表（Handle Table），也因其对性能的巨大影响而被重写了多次。在一个典型的系统上，同时运行着数十个进程、数百个线程和多达15万个打开的句柄，每个句柄都受到安全保护，其性能优化至关重要。

随着时间的推移，Windows操作系统不断演进。最初仅85KB的任务管理器，如今已膨胀到4MB，虽然功能更多，但并非成倍提升。卡特勒甚至抱怨，在他拥有64核128线程和96核192线程的强大工作站上，任务管理器显示每个CPU利用率的界面已经变得无法查看，密密麻麻的小方块让人眼花缭乱，只能查看整体性能。他希望能有更好的可视化选项，比如热力图或分组显示。

随后，卡特勒揭示了Longhorn（即后来的Vista）项目背后那段跌宕起伏的故事。Windows 2000完成后，工作站和服务器版本曾共享同一代码库。然而，当服务器团队预计下一个版本需要三年时，负责工作站的克里斯·琼斯（Chris Jones）却认为消费者版本可以在一年半内完成，因为消费者对质量的要求不如服务器用户。于是，代码库被一分为二：服务器版本继续其三年周期，而消费者版本（Longhorn）则走上了另一条路。然而，不久之后，消费者版本的软件就变得难以编译和运行，漏洞百出，并且未能及时整合服务器版本中修复的大量安全问题。与此同时，XP发布并取得了巨大成功，但其代码库却继承了Longhorn的缺陷，导致安全漏洞频发，缓冲区溢出攻击开始肆虐。

正是在这个混乱的时期，卡特勒与罗布·肖特（Rob Short）接见了AMD，后者提出了一种革命性的x64扩展方案，它对x86架构的侵入性极小，并能让32位应用程序在64位机器上全速运行。卡特勒敏锐地抓住了这个机会，尽管这并非公司正式批准的项目，他毅然决定启动x64项目。他选择使用更稳定、已修复大量安全漏洞的服务器代码库，目标是开发64位工作站和服务器。与此同时，Longhorn项目（此时已被戏称为“Does it Matterhorn”）仍在苦苦挣扎。当AMD终于交付了第一台x64系统时，卡特勒的团队将CD插入，系统竟然一次性启动成功，并且运行稳定，没有出现任何错误检查！这一突破立即引起了微软内部的关注。他们甚至说服了Microsoft.com网站切换到他们的64位服务器。令人惊讶的是，仅仅一周后，Microsoft.com就全面转向了64位系统。原因很简单：64位系统比32位系统可靠得多。32位系统因内存泄漏问题，虚拟内存很快就会耗尽，导致系统崩溃；而64位系统则能坚持更长时间。最终，Longhorn团队无法让他们的版本走出构建实验室，卡特勒直言不讳地告诉他的老板奥尔顿（Alton），应该切换到x64代码库。最终，他们采纳了这个建议，将Longhorn的代码库统一回了x64版本。

在整个过程中，XP的安全状况一度恶化到必须暂停所有工作来修复漏洞。卡特勒的团队修复了大约5000个漏洞，甚至不得不处理一些“糟糕透顶”的代码，特别是来自日本的IME（输入法编辑器）代码，其中充满了无法修复的溢出漏洞，只能通过缓解措施来应对。最终，微软发布了一个250MB的XP更新包，并将Longhorn的代码库切换到基于x64的统一代码库，这正是我们今天Windows操作系统的基础。至于Xbox，它的超管理器（hypervisor）则源自为Azure开发的Red Dog项目，虽然并非直接共享NT代码，但理念上有着相似之处。

# Chapter 9: 代码库的涅槃与云端序章：卡特勒的坚守与Xbox的秘密

在Windows XP的生命周期中，一些顽固的溢出漏洞如同难以根治的顽疾，团队竭尽全力也无法彻底修复，只能通过各种手段进行缓解。然而，一个里程碑式的更新——一个约250MB的庞大补丁包——不仅为XP带来了改进，更重要的是，它标志着Longhorn（后来的Windows Vista）的代码库正式切换到了x64架构。自此，Windows的核心代码库实现了前所未有的统一，这一架构沿用至今，成为现代Windows操作系统的基石。

就在64位系统发布后的那个星期四，戴夫·卡特勒做出了一个惊人的决定。第二天，他便向史蒂夫·鲍尔默发出了辞职邮件。他辞职的原因，源于对内部“FCIBs”（F***ing Checked-In Binaries，即那些直接签入二进制文件而非源代码的团队）现象的深恶痛绝。这些团队不提交源代码，导致移植工作异常艰难，严重阻碍了开发进程。卡特勒曾试图争取比尔·盖茨的支持来强制这些团队提交源代码，但未能成功，这让他感到极度沮丧和无力。鲍尔默收到辞职信后，并未直接接受，而是建议卡特勒休假，好好思考。卡特勒接受了，那是2005年3月28日。直到同年11月，随着天气转冷，无所事事的卡特勒决定重返工作岗位。2006年2月，他投身于一个全新的项目——Azure。

Azure项目由公司首席软件架构师雷·奥兹（Ray Ozzie）发起。奥兹观察到，微软内部虽然有许多团队在开发基于云的产品，但却缺乏一个统一的基础设施平台来支持这些应用。如何部署、配置、版本控制、重启应用？这些都是亟待解决的问题。于是，他成功说服鲍尔默和盖茨启动了这个名为“Red Dog”的项目，它最终演变成了我们今天所熟知的Azure。这个项目核心在于虚拟化技术。巧合的是，微软此前收购了Connectix公司，该公司带来了Virtual PC和Virtual Server两款产品，并且已经开始开发自己的虚拟机管理程序（Hypervisor）。微软在此基础上，将Connectix尚处于萌芽阶段的Hypervisor技术发展壮大，使其成为Azure的基石。

当卡特勒离开Azure转而投入Xbox项目时，Red Dog的Hypervisor技术也随之迁移，成为了Xbox Hypervisor的基础。Xbox的架构颇为独特，它同时运行着三个虚拟机（VM）。其中两个VM是常驻的：一个是“主机系统”（Host System），它掌控着所有硬件设备，并充当VM之间通信的“交通警察”；另一个是“演示系统”（Presentation System），负责用户界面和窗口管理。第三个则是“游戏VM”，它会根据玩家启动的游戏而动态创建和销毁。每个游戏都被打包成一个独立的VM，并附带一个特定版本的操作系统（通过GDK，即图形开发工具包提供）。这种设计确保了游戏的向后兼容性，因为游戏总是运行在它被开发时所依赖的操作系统版本上，不会因后续操作系统更新而失效。然而，这种模式也带来了更新的挑战。例如，当微软希望为Xbox引入“暂停/恢复”功能时，就必须找到一种方法将其植入到那些已经打包了旧版操作系统的游戏中。为此，他们开发了一个“通用游戏操作系统”，它能够根据游戏打包时的OS版本，动态翻译系统服务调用号，以实现兼容。

Xbox的操作系统基础也颇为讲究。主机系统和演示系统基于高度定制化的Windows 8，而游戏VM则基于Windows 11，两者都经过了大量裁剪，移除了Xbox不需要的功能。值得一提的是，它们与图形驱动程序的接口并不对称：一个使用标准的Windows 11图形栈，另一个则使用高度定制的DirectX栈，以最大化游戏性能。

将时间线拉回到更早的岁月，戴夫·卡特勒的传奇人生早在高中时期便已显现。他曾获得惊人的16个校队荣誉，这意味着他在四年高中生涯中，每年都同时参加了四项校队运动：田径、棒球、篮球和橄榄球。他的大学奖学金有四分之三来自体育特长，四分之一来自学业成绩。然而，体育生涯也伴随着伤痛。他曾在大二橄榄球赛季中摔断了腓骨，甚至在断腿的情况下坚持打完了半场比赛。当时的队医在两次注射止痛剂后，才让他继续上场。赛后，医生才建议去医院拍X光片，证实了骨折。次年春天，他在篮球比赛中撕裂了右膝半月板。在那个年代，任何涉及软骨的膝盖损伤，医生通常会选择直接切除软骨，这与今天尽可能修复或修剪的微创手术大相径庭。

# Chapter 10: 从运动场到代码世界：戴夫·卡特勒的早期磨砺与职业启蒙

戴夫·卡特勒的青年时代，充满了汗水与挑战。他曾因一次严重的运动损伤，腿部骨折，漫长的康复过程让他刻骨铭心。然而，命运似乎并未打算让他轻松。就在骨折痊愈的次年春天，他在篮球场上再次遭遇重创，右膝韧带撕裂。在那个年代，膝盖软骨一旦受损，医生往往选择直接切除，于是他的右膝半月板被无情地摘除。

尽管如此，戴夫并未放弃。他顽强地回归赛场，经历了八月密歇根酷热难耐的季前训练。然而，在赛季的第一场比赛中，厄运再次降临，他的左膝也遭受了同样的伤病。短短十到十二个月内，他经历了腿部骨折和两次膝盖手术，身体的痛苦和精神的打击可想而知。医生检查后直言他的膝盖异常脆弱，这番话彻底击垮了戴夫继续运动的念头。他意识到，当行走都成为奢望时，那种无助感是多么令人恐惧，他不想余生都活在这样的阴影下。于是，他毅然决定告别赛场。

幸运的是，戴夫的大学奖学金并未因此中断。他所就读的是一所三级联盟学校，没有严格意义上的“体育奖学金”，而是名为“助学金”的资助，任何学生都可以申请。他凭借在三项运动中的表现获得了三份助学金，同时还有一份学业奖学金。然而，这份学业奖学金要求他在两年后保持B的平均成绩，而他却偏偏在大学生涯中唯一一次拿到了B-的平均分，导致奖学金被取消。

尽管运动生涯充满坎坷，但戴夫从中学时代的一位教练——鲍勃·迪尔代（Bob Dilday）身上学到了宝贵的一课。迪尔代教练来自密歇根州立大学，曾与传奇四分卫汤米·尤西克并肩作战。他是一位充满斗志、渴望胜利的教练，总是能激励队员突破极限，挖掘出他们最大的潜力。戴夫深受其影响，他坚信成功的秘诀在于“做那些不成功的人通常拒绝做的事情”。

这种理念也深刻地影响了他后来的软件工程生涯。他反对那种“我只写代码，不测试”或“到点下班，不管项目进度”的态度。他认为，真正的成功者会不惜一切代价确保项目的成功，即使这意味着要为他人修复bug，或者在非工作时间投入更多精力。他引用了弗雷德·布鲁克斯的名言：“思想家多如牛毛，实干家凤毛麟角，而思想与实干兼备者则世间罕有。”他强调，架构师不仅要思考，更要确保他们的设计能够真正实现目标，满足所有约束条件。

大学毕业后，戴夫的第一份正式工作是在杜邦公司，负责一个为斯科特纸业（Scott Paper）服务的项目。他所在的大学是一所与教会 loosely 相关的文理学院，他当初上大学的目的仅仅是为了打球，并没有明确的职业规划。然而，在大学期间，他对数学和物理产生了浓厚兴趣。他从小就喜欢建造东西，甚至在18岁时就带领团队建造谷仓。因此，他渴望找到一份工程类工作，但投递给航空航天等行业的简历都石沉大海。最终，杜邦公司向他伸出了橄榄枝。

然而，这份工作却让他大失所望。他本以为会从事弹性材料的测试方法研究，结果却是枯燥乏味的测试方法文档编写。英语并非他的强项，而杜邦内部三个不同部门（生产、销售服务实验室和研究组）对测试方法都有各自的编辑和审批流程，导致他提交的文档从未获得通过。

在极度无聊之际，杜邦的数学与统计分析小组向他抛出了橄榄枝，邀请他参与一个计算机模拟项目——为斯科特纸业公司新开发的离心铸造泡沫生产工艺建立模型。斯科特纸业为了解决传统泡沫生产工艺中切割边角料造成的巨大浪费，发明了这种创新的离心铸造技术。传统的泡沫生产线就像一条无尽的传送带，两种化学物质混合后倾倒在纸上，神奇地膨胀成六英尺宽、四英尺高、六十英尺长的“泡沫原木”，再经过切割、钻孔、旋转剥离成薄片。而离心铸造则是在一个长达三十英尺、直径五英尺的巨大旋转笼式滚筒中进行，纸张和混合好的泡沫液被注入其中，泡沫在旋转中膨胀，最终被切割成十五英尺长的圆柱形“扎克”，旨在消除边角料浪费。

戴夫对这份新工作欣然接受，他当时对文档工作的厌倦程度，甚至觉得当个清洁工都会更有趣。于是，他前往纽约波基普西参加IBM GPSS-III离散模拟语言的培训，在那里他了解到奥的斯电梯公司也在用这种语言模拟高层建筑的电梯调度算法。学成归来后，他与斯科特纸业的团队会面，并被指派与一名实习生共同开发这个模型，以便在自己离开后，实习生能够接手。他开始用GPSS-III这种基于流程图的、纯粹顺序执行的语言构建模型，这标志着他从枯燥的文档工作转向了充满挑战和乐趣的计算机世界。

# Chapter 11: 代码的洗礼：从模拟到机器的深层探索

戴夫·卡特勒的早期职业生涯，充满了意想不到的转折与深刻的启示。在杜邦公司，他被指派去模拟高层办公楼的电梯运行算法和交通信号灯系统，这项工作听起来枯燥，却为他打开了通往计算机世界的大门。

他被派往斯科特纸业公司，与一位实习生共同完成一个项目。戴夫的任务是开发模型，并将知识传授给实习生，以便在他离开后，实习生能接手。他使用的语言是GPSS-III，一种基于流程图的离散模拟语言。这种语言通过一个个小方框代表特定操作，它们按顺序连接，就像绘制流程图一样。程序逻辑被编码在打孔卡上，然后输入计算机。这并非传统的编译，更像是一种数据驱动的模拟，尽管其中也包含跳转（go-to）等逻辑控制。

戴夫投入其中，乐此不疲。然而，他很快就遭遇了职业生涯中最“屈辱”的一天。当他带着大约一千张打孔卡组成的模型，与IBM代表、他的老板以及斯科特纸业的同事一同前往费城的数据中心时，一切都变了。那是一个调度严格、时间精确到秒的“疯人院”，每项操作都需要在时间戳机器上盖章。当他们终于轮到使用IBM 7044大型机，装载卡片组，启动磁带后，计算机仅仅读取了大约十张卡片，就“死机”了。结果令人震惊：在一千张卡片中，竟然有五百个错误！他们花了一整天试图修复，却越修越多，最终无功而返。

这次惨痛的经历让戴夫深受打击，他从未在如此精确的工作中犯下如此多的错误。回到杜邦后，他决定利用工程部门的UNIVAC 1107（后来的1108）计算机服务。当时，很少有人亲自打孔卡，通常是手写代码，然后交给打孔员，再由另一人验证。即便如此，错误依然层出不穷。戴夫决定自己动手，用Fortran编写了一个程序，专门用来检查并修正这些打孔错误。这个程序，用他自己的话说，可能是“人类写过的最糟糕的程序”，但它却奇迹般地解决了问题，让他们得以重返数据中心。

在后续的调试过程中，戴夫开始遇到逻辑错误，并在反复修改中，对计算机本身产生了浓厚的兴趣。编译器如何将文本转化为机器指令？这让他着迷。他找来一本IBM 7044汇编语言手册，研究GPSS-III中的“帮助块”（help block）——一个允许用户插入自定义代码的模块。他最终写了一个包含大约一千张汇编卡片的“帮助块”。正是在这个过程中，戴夫意识到，他真正感兴趣的，不是用计算机解决问题，而是计算机本身的工作原理。这一觉醒发生在1967年左右，彻底改变了他未来的职业方向。

多年以后，当他回顾自己设计操作系统（如RSX、VMS、NT）的历程时，他反思了程序员在解决问题时的“三阶段”理论：初次尝试时写出糟糕的版本，第二次过度设计，第三次才找到恰到好处的方案。他认为，RSX-11M并非过度设计的系统，它被严格限制在32KB内存中，必须运行文件系统、Fortran编译器和链接器，他的口号是“大小即目标”。VMS也受到发布日期的严格限制，尽管他们曾短暂研究Unix并试图借鉴其优点，但最终VMS的特性并未显现出Unix的影子。NT则相对乐观，但一个名为Mica的宏大设计差点让它走向灾难。Mica的设计团队中许多人缺乏实际构建操作系统的经验，倾向于将所有功能都塞进操作系统核心，其对象架构极其复杂。幸运的是，Mica最终被精简，这反而帮助NT变得更加实用和成功。

戴夫认为，NT已经证明了其极强的可塑性和可扩展性。尽管安全问题层出不穷，但现代的安全挑战已与VMS时代截然不同。过去，他们曾尝试构建一个名为ASICure VMS的单用户安全系统，但其运行速度慢得令人发指。而如今，最严重的问题往往不是代码缺陷，而是硬件特性或人们利用硬件漏洞来攻破系统的方式，例如最近的“阈值漏洞”（threshold bug），一个仅存在于Intel处理器上的推测执行相关问题，这让他对计算机的理解和挑战始终保持着警惕和好奇。

# Chapter 12: 处理器安全：从硬件漏洞到侧信道攻击

“如今，最棘手的问题已不再是简单的程序错误，”他沉思着说，“而是那些因硬件特性或人们巧妙利用硬件漏洞而引发的系统崩溃。”他举了一个最近的例子，虽然有些人可能称之为硬件缺陷，但其影响深远。

这便是“阈值漏洞”（Threshold bug），一个仅限于英特尔处理器的独特问题，AMD芯片则幸免于难。在现代处理器中，为了追求极致性能，它们会进行大量的“推测执行”，即提前运行指令。英特尔处理器在遇到访问违规时，并不会立即停止，而是简单地设置一个“错误”标记，然后让推测执行继续进行。直到稍后，当这条指令真正尝试“退役”时，系统才发现它是个“坏指令”，此时不得不回溯并撤销之前所有的推测操作。这听起来似乎没什么大碍，但问题就出在一个关键的漏洞上：在发现访问违规之后，英特尔处理器竟然允许软件访问那些本不应被访问的缓存变量。这为攻击者打开了一扇大门，他们可以通过精确测量访问这些变量的时间，来解码出敏感信息。而AMD处理器则采取了截然不同的策略，一旦检测到访问违规，它们会立即停止所有操作，从而有效地避免了此类问题的发生。

“阈值漏洞”曾引发了巨大的安全风波，但最新的挑战则更为隐蔽——“侧信道攻击”。这类攻击的精髓在于，攻击者并非直接窃取数据，而是通过观察系统操作的“副作用”来推断数据。这就像你做了一件事，别人却能从你做这件事的方式或结果中，间接猜出你隐藏的信息。

其中一个典型的例子就是利用“分支目标缓冲区”（Branch Target Buffer, BTB）的攻击，也就是著名的“幽灵”（Spectre）漏洞。处理器中的“分支预测”机制会预测程序的分支走向，而BTB则更进一步，它预测的是下一条指令的具体位置。你可能会好奇，这怎么可能呢？实际上，处理器会维护一个缓存，记录着下一条指令可能的位置。如果预测看起来合理，它就会提前开始执行。

然而，攻击者却能利用这一点制造信息泄露。他们可以精心构造代码，预先“加载”或“训练”分支目标缓冲区，使其按照攻击者预设的方式进行预测。然后，他们请求操作系统执行某些操作，而这些操作在推测执行时会受到被污染的BTB的影响。通过测量缓存访问的时间差异，攻击者就能将这些时序信息转化为实际的数据，从而绕过安全防护，窃取敏感信息。

这些案例清晰地表明，安全问题的本质已经发生了深刻的变化，从直接的程序错误转向了更深层次、更难以察觉的硬件交互与推测执行的漏洞。

# Chapter 13: 云游戏与历史回响：从Xbox到早期计算机的探索

故事从一个充满未来感却又脚踏实地的项目开始——xCloud。想象一下，成千上万台Xbox主机不再仅仅是客厅里的娱乐设备，它们被精心重新封装，整齐地排列在数据中心的机架上，为全球玩家提供远程云游戏服务。这不仅让玩家能随时随地体验3A级大作，更巧妙的是，这些“单租户”系统在玩家不活跃的闲暇时段，并没有被浪费。微软的工程师们，包括故事的主人公，正致力于让这些Xbox主机在空闲时运行Linux虚拟机，承载微软内部的AI和机器学习工作负载，充分利用每一份计算资源。

主人公投入了大量精力，首先要让Linux系统能在Xbox的Hypervisor上稳定运行，接着是攻克复杂的图形栈。这项工作耗时漫长，让他感觉仿佛“永远”都在为此忙碌。他甚至开玩笑说，这项任务比他当年在虚拟机领域的工作还要久远。

谈及编程的艰辛，他分享了一个趣闻。几年前，他向华盛顿大学新建的计算机科学大楼捐款，作为回报，一间宽敞的实验室将以他的名字命名。他提出了一个特别的要求：在实验室的墙上刻上一句座右铭——“如果你不把它们放进去，你就不用把它们取出来。”这句看似简单的话，实则蕴含着深刻的编程哲学：在代码编写之初就力求完美，避免引入错误，这样后期就无需耗费巨大精力去调试和修复。

他回忆起早年编程的“黑暗时代”，那时的调试工具简陋得令人发指。他正在研究一台KIM-1单板机，那是一台基于6502处理器、拥有64K内存的机器，没有调试器，没有`printf`，唯一的输入方式是一个十六进制键盘。在这种环境下编写代码，必须小心翼翼，因为任何一个错误都意味着漫长的排查过程。而如今，桌面模拟器和先进的开发工具让调试变得轻而易举，代码的迭代速度大大加快，这彻底改变了编程的方式。他感叹，现代工具虽然提高了效率，但也可能让一些年轻的开发者对代码质量的重视程度有所下降，因为许多细微的错误都能被工具自动捕获或修正。

话题转向了更古老的硬件。他提到了一些传奇般的机器，比如Burroughs、Bunk & Ramo，甚至还有更早的Bendix——一台以鼓式存储器作为主内存的机器。他生动地描述了鼓式存储器的工作原理：程序指令被巧妙地安排在高速旋转的鼓面上，以确保一条指令执行完毕后，鼓面恰好旋转到下一条指令的位置，从而实现最快的访问速度。他还提到了1108计算机上那些令人难以置信的鼓，它们以7500 RPM的速度旋转，采用独特的“规范”设计，在高速旋转时会略微抬升以避免磁头碰撞，其最小访问时间在当时达到了惊人的三毫秒。与今天的固态硬盘（SSD）几乎零延迟的访问速度相比，这无疑是天壤之别，也深刻地改变了计算机的性能格局。

在轻松的闲聊中，他透露自己每年大约有六周的假期，大部分时间在夏威夷的住所度过，享受骑行。他表示自己仍然热爱工作，如果不是因为没有像朋友那样拥有一个充满兴趣的私人车库，他可能会在家感到迷茫。

随后，他们聊到了计算机博物馆。他遗憾地提到西雅图的“活体计算机博物馆”（The Living Computer Museum）已经关闭，那是一个令人印象深刻的地方，所有展出的老机器都能实际运行。他猜测这可能与创始人保罗·艾伦的遗嘱中没有明确的资金支持有关。他更喜欢这类展示老旧机器的博物馆，而非仅仅关注最新技术的计算机历史博物馆。他自己也曾去过位于山景城的计算机历史博物馆，那里有他的照片，并计划去普基普西参观IBM的数据中心，了解他们最新的技术。他甚至开玩笑说，希望IBM能送他一台System/360到他的工作室，尽管那巨大的功耗和三相电需求是个不小的挑战。

最后，他们深入探讨了IBM早期机器的架构，特别是36位和24位浮点数的精度问题。他解释说，早期的36位浮点数没有“隐藏位”，而IBM System/360引入了带有隐藏位的24位尾数，虽然增加了1位精度，但24位在今天看来仍然相当有限。这场关于历史与未来的技术对话，充满了对计算机发展历程的深刻洞察。

